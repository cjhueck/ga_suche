<!DOCTYPE html>

<html lang="de">
<head>
<meta charset="utf-8"/>
<title>GA Steiner Suche - Unified</title>
<style>
#themes {
  padding-top: 0.2rem !important;
  outline: 2px dashed red !important;
}

#themeInput {
  margin-top: 0.2rem !important;
  margin-bottom: 0.3rem !important;
  outline: 2px dashed blue !important;
}

.theme-options {
  margin-top: 0 !important;
  margin-bottom: 0.3rem !important;
  outline: 2px dashed green !important;
}

#theme-results {
  font-family: monospace !important;
  font-size: 1rem !important;
  line-height: 1.7 !important;
  outline: 2px dashed orange !important;
}

#themes {
  padding-top: 0.2rem !important;
}

#themeInput {
  margin-top: 0.2rem !important;
  margin-bottom: 0.3rem !important;
}

.theme-options {
  margin-top: 0 !important;
  margin-bottom: 0.3rem !important;
}

#theme-results {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  line-height: 1.5;
  font-size: 0.95rem;
}

#themes-tab-content {
  padding-top: 0 !important;
  margin-top: 0 !important;
}

#themes-tab-content * {
  margin-top: 0 !important;
  margin-bottom: 0 !important;
  padding-top: 0 !important;
  padding-bottom: 0 !important;
  gap: 0 !important;
}

/* Etwas Luft nur da, wo es nötig ist – gezielt */
#themes-tab-content textarea {
  margin-bottom: 0.3rem !important;
}

#themes-tab-content select {
  margin-right: 0.3rem !important;
}

#themes-tab-content button {
  margin-top: 0.3rem !important;
}

/* Abstand oben reduzieren */
#themes-tab-content {
  margin-top: 0 !important;
  padding-top: 0 !important;
}

/* Abstand zwischen Textarea und Dropdown-Container */
#themes-tab-content textarea + div {
  margin-top: 0.2rem !important;
}

/* Abstand zwischen Dropdowns und Buttons */
#themes-tab-content textarea + div + div {
  margin-top: 0.2rem !important;
}

#themes-tab-content textarea {
  margin-top: 0.2rem !important;
  margin-bottom: 0.2rem !important;
}

#themes-tab-content .theme-dropdowns {
  margin-bottom: 0.2rem !important;
}

#themes-tab-content .theme-options {
  margin-top: 0.2rem !important;
}

#themes-tab-content {
  padding-top: 0 !important;
  margin-top: 0 !important;
}

/* Verringert Abstand zwischen Tab-Leiste und Textarea */
#themes-tab-content > textarea,
#themes-tab-content textarea {
  margin-top: 0.3rem !important;
  display: block;
}

/* Verringert Abstand zwischen Textarea und dem Block mit Dropdowns */
#themes-tab-content textarea + div {
  margin-top: 0.3rem !important;
}

/* Reduziert vertikalen Abstand unterhalb der Menüs */
#themes-tab-content .theme-options {
  margin-top: 0.3rem !important;
}

/* Sicherheitsregel für alles im Tab-Inhalt */
#themes-tab-content * {
  line-height: 1.4;
  margin-top: 0.3rem;
}

/* Abstand zwischen Tabs und Textarea */
#themes-tab-content textarea {
  margin-top: 0.3rem !important;
}

/* Abstand zwischen Textarea und Dropdowns */
#theme-inputs {
  margin-top: 0.2rem !important;
  gap: 0.4rem !important;
}

/* Abstand unterhalb der Menüs */
#theme-options {
  margin-top: 0.2rem !important;
}

/* Abstand zwischen Tabs und Eingabefeldern */
#themes-tab-content {
  margin-top: 0.3rem !important;
  padding-top: 0 !important;
}

/* Abstand zwischen Eingabefeld und Dropdown-Menüs */
#theme-inputs {
  gap: 0.5rem !important;
  margin-bottom: 0.3rem !important;
}

/* Schrift im Themen-Ausgabefenster anpassen */
.theme-section {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif !important;
  font-size: 0.95rem !important;
  line-height: 1.6 !important;  /* etwas größerer Zeilenabstand */
  color: #333 !important;
}

#theme-results {
  margin-top: 0 !important;
  padding-top: 0 !important;
}

.theme-section {
  margin-top: 0.5rem !important;
  padding-top: 0 !important;
}

#searchInfo {
  margin-bottom: 0 !important;
  padding-bottom: 0 !important;
}

#results {
  margin-top: 0 !important;
  padding-top: 0 !important;
}

.summary-buttons {
  padding-bottom: 0.2rem !important;
}

#summary-content {
  padding-top: 0.5rem !important;
  margin-top: 0 !important;
}

#toc-list {
  margin-top: 0 !important;
  padding-top: 0 !important;
}


#searchInfo {
  margin-bottom: 0 !important;
  padding-bottom: 0 !important;
}

ul.results-list {
  margin-top: 0 !important;
  padding-top: 0 !important;
  line-height: 1.3;
}

ul.results-list {
  margin-top: 0 !important;
  padding-top: 0 !important;
}

#results {
  margin-top: 0 !important;
  padding-top: 0 !important;
}

body.dark-mode #summary-content,
body.dark-mode #summary-content * {
  color: #7EB8C8 !important;
}

.search-input,
.filter-dropdown {
  font-size: 0.9em;
  font-size: 0.9em;
}

#site-title { font-size: 1.8rem; 
            margin-left: 0.5rem;
            margin-top: 0.5rem; }

    html, body { scroll-behavior: auto; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, Ubuntu, sans-serif;
      height: 100vh;
      display: flex;
      transition: background-color 0.3s, color 0.3s;
    }
    
    body.dark-mode {
      background-color: #1a1a1a;
      color: #e0e0e0;
    }
    
    body.dark-mode #sidebar {
      background-color: #2a2a2a;
      border-right-color: #404040;
    }
    
    body.dark-mode #sidebar-header {
      background-color: #2a2a2a;
      border-bottom-color: #404040;
      padding: 0.5rem;
}
    
    body.dark-mode #main {
      background-color: #1a1a1a;
      color: #e0e0e0;
    }
    
    body.dark-mode #summary-panel {
      background-color: #2a2a2a;
      border-left-color: #404040;
    }
    
    body.dark-mode .search-input,
    body.dark-mode .filter-dropdown,
    body.dark-mode .thematic-input {
      background-color: #333;
      color: #e0e0e0;
      border-color: #555;
    }
    
    body.dark-mode .search-input:-webkit-autofill,
    body.dark-mode .search-input:-webkit-autofill:hover,
    body.dark-mode .search-input:-webkit-autofill:focus {
      -webkit-box-shadow: 0 0 0 30px #333 inset !important;
      -webkit-text-fill-color: #e0e0e0 !important;
      box-shadow: 0 0 0 30px #333 inset !important;
    }
    
    .search-input:-webkit-autofill,
    .search-input:-webkit-autofill:hover,
    .search-input:-webkit-autofill:focus {
      -webkit-box-shadow: 0 0 0 30px white inset !important;
      -webkit-text-fill-color: #000 !important;
      box-shadow: 0 0 0 30px white inset !important;
    }
    
    body.dark-mode mark {
      background: rgba(70, 120, 134, 0.5);
      color: #fff;
    }
    
    body.dark-mode .highlighted-paragraph {
      background: rgba(70, 120, 134, 0.35);
    }
    
    body.dark-mode #viewer .highlighted-paragraph {
      background: rgba(70, 120, 134, 0.35);
    }
    
    body.dark-mode .resize-handle,
    body.dark-mode .vertical-resize-handle {
      background-color: #666;
    }
    
    body.dark-mode .resize-handle:hover,
    body.dark-mode .vertical-resize-handle:hover {
      background-color: #999;
    }
    
    body.dark-mode .snippet {
      color: #d0d0d0;
    }
    
    
    
    
    
    body.dark-mode .toc-item {
      border-bottom-color: #404040;
    }
    
    body.dark-mode .toc-item a {
      color: #5eb0cb !important;
    }
    
    body.dark-mode .toc-item a:hover {
      color: #7eb8c8 !important;
    }
    
    
    
    
    
    body.dark-mode body.dark-mode ul.results-list > li > a {
      color: #7eb8c8;
      font-size: 0.95em;
}
    
    body.dark-mode .tab-button {
      color: #999;
    }
    
    body.dark-mode .tab-button.active {
      color: #7eb8c8;
      border-bottom-color: #7eb8c8;
    }
    
    body.dark-mode .semantic-answer {
      background: #2a3a3f;
    }
    
    body.dark-mode ::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }
    
    body.dark-mode ::-webkit-scrollbar-track {
      background: #2a2a2a;
    }
    
    body.dark-mode ::-webkit-scrollbar-thumb {
      background: #555;
      border-radius: 6px;
    }
    
    body.dark-mode ::-webkit-scrollbar-thumb:hover {
      background: #666;
    }
    
    body.dark-mode * {
      scrollbar-width: thin;
      scrollbar-color: #555 #2a2a2a;
    }
    
    .theme-switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
    }
    
    .theme-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .theme-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.3s;
      border-radius: 24px;
    }
    
    .theme-slider:before {
      position: absolute;
      content: "☀️";
      height: 14px;
      width: 14px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    
    input:checked + .theme-slider {
      background-color: #467886;
    }
    
    input:checked + .theme-slider:before {
      transform: translateX(18px);
      content: "🌙";
    }
    
    body.dark-mode .theme-slider {
      background-color: #467886;
    }
    
    #sidebar {
      display: flex;
      flex-direction: column;
      width: 450px;
      min-width: 450px;
      max-width: none;
      overflow: hidden;
      border-right: 1px solid #ddd;
      padding: 0;
      box-sizing: border-box;
      position: relative;
      transition: width 0.3s ease, min-width 0.3s ease;
    }
    
    #sidebar-header {
      flex-shrink: 0;
      padding: 0.5rem;
      background: inherit;
      overflow-y: auto;
      max-height: 60vh;
      padding: 0.5rem;
}
    
    #sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 0rem 1rem 1rem 1rem;
    }
    
    #sidebar.collapsed {
      width: 0;
      min-width: 0;
      padding: 0;
      border-right: none;
      overflow: visible;
    }
    
    #sidebar.collapsed > *:not(.sidebar-toggle) {
      display: none;
    }
    
    .sidebar-toggle {
      position: fixed;
      left: 0 !important;
      bottom: 30px;
      width: 24px;
      height: 80px;
      background: #d0e8ef;
      border: 2px solid #467886;
      border-radius: 0 8px 8px 0;
      border-left: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: #467886;
      transition: background 0.2s;
      z-index: 1000;
      transform: translateZ(0);
      will-change: auto;
    }
    
    .sidebar-toggle:hover {
      background: #b8dde8;
    }
    
    .resize-handle {
      width: 1px;
      background-color: #ddd;
      cursor: col-resize;
      position: relative;
      flex-shrink: 0;
      transition: background-color 0.2s;
    }
    
    .resize-handle::before {
      content: '⋮';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #999;
      font-size: 32px;
      line-height: 1;
    }
    
    .resize-handle:hover {
      background-color: #ccc;
      width: 3px;
    }
    
    .resize-handle:hover::before {
      color: #666;
    }
    
    #main-container {
      flex: 1;
      display: flex;
      flex-direction: row;
      min-width: 0;
      overflow: hidden;
    }
    
    #main {
      flex: 1;
      overflow-y: auto;
      padding: 2rem;
      min-width: 0;
      line-height: 1.45;
      position: relative;
    }
    
    body.dark-mode .depth-btn {
      background: #2a2a2a;
      color: #d0d0d0;
      border: 1px solid #7eb8c8;
    }
    
    body.dark-mode .depth-btn.active {
      background: #2a2a2a;
      color: #d0d0d0;
      border: 2px solid #7eb8c8;
    }
    
    body.dark-mode .depth-btn.primary {
      background: #467886;
      color: #e0e0e0;
      border: 2px solid #467886;
    }
    
    body.dark-mode .depth-btn.primary:hover {
      background: #355d68;
      border-color: #355d68;
    }
    
    body.dark-mode .summary-buttons .search-button {
      background: #2a2a2a;
      color: #d0d0d0;
      border-color: #7eb8c8;
    }
    
    body.dark-mode .summary-buttons .search-button:hover {
      background: #3a3a3a;
    }
    
    #main p {
      margin: 0.8em 0;
    }
    
    #summary-panel {
      display: flex;
      flex-direction: column;
      border-left: none;
      overflow: hidden;
      width: 0;
      min-width: 0;
      background: transparent;
      position: relative;
      transition: width 0.3s ease, background-color 0.3s ease, border-left 0.3s ease;
      margin-right: 24px;
    }
    
    #summary-panel.visible {
      width: 280px;
      min-width: 280px;
      max-width: none;
      background: #fafafa;
      border-left: 1px solid #ddd;
      margin-right: 24px;
    }
    
    .summary-panel-toggle {
      position: fixed !important;
      right: 0 !important;
      bottom: 30px;
      width: 24px;
      height: 80px;
      background: #d0e8ef;
      border: 2px solid #467886;
      border-radius: 8px 0 0 8px;
      border-right: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: #467886;
      transition: background 0.2s;
      z-index: 1000;
      transform: translateZ(0);
      will-change: auto;
    }
    
    .summary-panel-toggle:hover {
      background: #b8dde8;
    }
    
    .vertical-resize-handle {
      width: 1px;
      background-color: #ddd;
      cursor: col-resize;
      position: relative;
      flex-shrink: 0;
      transition: background-color 0.2s, width 0.2s;
      display: none;
    }
    
    .vertical-resize-handle::before {
      content: '⋮';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #999;
      font-size: 24px;
      line-height: 1;
    }
    
    .vertical-resize-handle.visible {
      display: block;
    }
    
    .vertical-resize-handle:hover {
      background-color: #ccc;
      width: 3px;
    }
    
    .vertical-resize-handle:hover::before {
      color: #666;
    }
    
    #summary-content {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      line-height: 1.5;
      font-size: 0.95em;
      display: none;
    }
    
    #summary-panel.visible #summary-content {
      display: block;
    }
    
    .summary-buttons {
      padding: 1rem;
      border-top: 1px solid #ddd;
      display: none;
      flex-direction: column;
      gap: 8px;
    }
    
    #summary-panel.visible .summary-buttons {
      display: flex;
    }
    
    body.dark-mode .summary-buttons {
      border-top-color: #404040;
    }
    
    .summary-buttons .search-button {
      width: 100%;
      text-align: center;
    }
    
    #summary-content h3 {
      font-size: 1.0em;
      margin: 1.0em 0 0.3em 0;
      font-weight: 700;
      color: #467886;
      cursor: pointer;
      transition: color 0.2s;
      line-height: 1.1;
    }
    
    #summary-content h4 {
      font-size: 0.9em;
      margin: 0.6em 0 0.2em 0;
      font-weight: 600;
      color: #467886;
      cursor: pointer;
      transition: color 0.2s, opacity 0.2s, max-height 0.3s;
      padding-left: 1.2em;
      line-height: 1.1;
      overflow: hidden;
    }
    
    #summary-content h4.hidden {
      display: none;
    }
    
    #summary-content h3:hover,
    #summary-content h4:hover {
      color: #355d68;
    }
    
    #summary-content .toc-item {
      padding: 0.4em 0;
      border-bottom: 1px solid #e0e0e0;
    }
    
    #summary-content .toc-item:last-child {
      border-bottom: none;
    }
    
    h1 { margin-bottom: 0.5rem; margin-top: 0; }
    #document-title { margin-top: 0; margin-bottom: 1rem; }
    #document-title a { color: #467886; text-decoration: none; }
    #document-title a:hover { text-decoration: underline; }
    
    body.dark-mode #document-title a {
      color: #7EB8C8 !important;
    }
    
    .tab-container {
      margin-bottom: 1rem;
    }
    
    .tab-buttons {
      display: flex;
      border-bottom: none;
      margin-bottom: 1rem;
    }
    
    body.dark-mode .tab-buttons {
      border-bottom-color: transparent;
    }
    
    .tab-button {
      padding: 8px 16px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      color: #666;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    
    .tab-button.active {
      color: #467886;
      border-bottom-color: #467886;
    }
    
    .tab-button:hover {
      color: #467886;
      opacity: 0.7;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .thematic-input {
      width: 100%;
      padding: 10px;
      margin: 0px 0;
      box-sizing: border-box;
      border: 1px solid #467886;
      background: white;
      font-size: 15px;
      min-height: 80px;
      resize: vertical;
      border-radius: 4px;
      line-height: 20px; 
    }
    
    .semantic-options {
      margin: 10px 0;
    }
    
    .depth-buttons {
      display: flex;
      gap: 8px;
      margin: 8px 0;
    }
    
    .depth-btn {
      padding: 6px 12px;
      border: 1px solid #467886;
      background: white;
      color: #467886;
      cursor: pointer;
      border-radius: 4px;
      font-size: 0.9em;
      transition: all 0.2s;
    }
    
    .depth-btn.active {
      background: white;
      color: #467886;
      border: 2px solid #467886;
    }
    
    .depth-btn.primary {
      background: #467886;
      color: white;
      border: 2px solid #467886;
    }
    
    .depth-btn.primary:hover {
      background: #355d68;
      border-color: #355d68;
    }
    
    .depth-btn:hover {
      opacity: 0.8;
    }
    
    .depth-btn:disabled {
      cursor: not-allowed;
      background: #f5f5f5;
      opacity: 0.6;
    }
    
    .depth-btn.primary:disabled {
      background: #ccc;
      border-color: #ccc;
      cursor: not-allowed;
      color: #467886;
    }
    
    .depth-btn.processing {
      font-style: italic;
    }
    
    .ga-reference {
      color: #467886;
      text-decoration: none;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 3px;
      background: rgba(70, 120, 134, 0.1);
      transition: all 0.2s ease;
      cursor: pointer;
      border: 1px solid transparent;
    }
    
    .ga-reference:hover {
      background: rgba(70, 120, 134, 0.2);
      border-color: #467886;
      text-decoration: none;
    }
    
    .highlighted-paragraph {
      background: rgba(70, 120, 134, 0.1);
      padding: 0.5rem;
      border-radius: 4px;
      margin: 0.2rem 0;
    }
    
    .semantic-answer {
      background: #f0f8ff;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
    }
    
    .semantic-answer h3 {
      display: none;
    }
    
    .answer-content {
      line-height: 1.3;
      font-size: 0.9em; 
    }
    
    .answer-content h1 {
      display: none;
    }
    
    .answer-content h2 {
      font-size: 1.1em;
      margin: 0.4em 0 0.2em 0;
      font-weight: 600;
    }
    
    .answer-content h3 {
      font-size: 1.0em;
      margin: 0.3em 0 0.2em 0;
      font-weight: 600;
      display: block;
    }
    
    .answer-content p {
      margin: 0.3em 0;
      font-weight: normal;
    }
    
    .answer-content strong {
      font-weight: 600;
    }
    
    .answer-content ul, .answer-content ol {
      margin: 0.3em 0;
      padding-left: 1.5em;
    }
    
    .loading {
      color: #467886;
      font-style: italic;
    }
    
    .error-message {
      background: #fff5f5;
      border-left: 4px solid #e53e3e;
      padding: 10px;
      margin: 10px 0;
      color: #c53030;
      border-radius: 0 4px 4px 0;
    }
    
    .search-input {
      width: 100%;
      padding: 8px;
      margin: 4px 0;
      box-sizing: border-box;
      border: 1px solid #ccc;
      background: white;
      font-size: 0.9em;
      font-size: 0.9em;
}
    
    .filter-row {
      display: flex;
      gap: 10px;
      margin-top: 6px;
    }
    
    .filter-dropdown {
      flex: 1;
      height: auto;
      min-height: 2.2em;
      padding: 8px;
      margin: 4px 0;
      font-size: 0.9em;
      box-sizing: border-box;
      border: 1px solid #ccc;
      background: white;
      font-size: 0.9em;
}
    
    .filter-dropdown:disabled {
      background: #f5f5f5;
      color: #999;
      cursor: not-allowed;
    }
    
    .radio-group {
      margin: 6px 0;
      display: flex;
      gap: 12px;
    }
    
    .radio-group label {
      cursor: pointer;
    }
    
    .radio-group input[type="radio"]:checked + span {
      color: #467886;
      font-weight: 600;
    }
    
    body.dark-mode .radio-group input[type="radio"]:checked + span {
      color: #7EB8C8;
    }
    
    .search-button {
      padding: 6px 12px;
      border-radius: 4px;
      border: 2px solid #467886;
      background: white;
      color: #467886;
      cursor: pointer;
      font-size: 0.9em;
      margin-bottom: 0.4rem;
    }
    
    .search-button:hover { opacity: .85; }
    .search-button:disabled {
      cursor: not-allowed;
      background: #f5f5f5;
      color: #999;
      opacity: 1;
    }
    
    .search-button.processing {
      font-style: italic;
    }
    
    #note { margin-top: 0.5rem; font-size: 0.9em; color: #666; }
    
    ul.results-list { 
      list-style-type: disc; 
      padding-left: 1.2em; 
      margin: 0;
      padding-top: 0.3rem;
    }
    ul.results-list > li > a { font-weight: bold; color: #467886;   font-size: 0.9em;
}
    ul.sub-headings { list-style-type: none; padding-left: 1.5em; margin: 0.25em 0; }
    ul.sub-headings li::before { content: "– "; color: #333; }
    a { color: #467886; text-decoration: none; cursor: pointer; }
    a:hover { text-decoration: underline; }
    .snippet { font-size: 0.9em; color: #444; margin: 4px 0; cursor: pointer; }
    mark { 
      background: rgba(70, 120, 134, 0.2); 
      color: inherit;
    }
    
    .paragraph { 
      margin: 0.8em 0;
      line-height: 1.4;
    }
    
    #viewer {
      line-height: 1.4;
    }
    
    #viewer .paragraph {
      margin-bottom: 0.8em;
    }
    
    #viewer p {
      margin: 0.8em 0;
      line-height: 1.45;
    }
    
    #viewer .highlighted-paragraph {
      background: rgba(70, 120, 134, 0.1);
      padding: 0.5rem;
      border-radius: 4px;
      margin: 0.2rem 0;
    }
    
    #viewer h3 {
      font-size: 1.1em;
      margin: 1.5em 0 0.5em 0;
      font-weight: 700;
      color: #467886;
      display: block;
    }
    
    #viewer h4 {
      font-size: 1.0em;
      margin: 1.0em 0 0.3em 0;
      font-weight: 600;
      color: #467886;
      display: block;
    }
    
    body.dark-mode #viewer h3,
    body.dark-mode #viewer h4 {
      color: #7EB8C8 !important;
    }
    
    #viewer h3:first-child,
    #viewer h4:first-child {
      margin-top: 0;
    }
    
    #viewer > p:first-of-type {
      font-style: italic;
      margin-bottom: 1rem;
    }
  
/* PATCH: Vereinheitlichung der blauen Farbe im Darkmode (#7EB8C8) */

body.dark-mode ul.results-list > li > a {
  color: #7EB8C8 !important;
}

body.dark-mode .toc-item a {
  color: #7EB8C8 !important;
}

body.dark-mode #viewer h3,
body.dark-mode #viewer h4 {
  color: #7EB8C8 !important;
}

body.dark-mode #summary-content h3,
body.dark-mode #summary-content h4 {
  color: #7EB8C8 !important;
}

body.dark-mode #document-title a {
  color: #7EB8C8 !important;
}

body.dark-mode .tab-button.active {
  color: #7EB8C8 !important;
  border-bottom-color: #7EB8C8 !important;
}

body.dark-mode .ga-reference {
  color: #7EB8C8 !important;
  border-color: #7EB8C8 !important;
}

body.dark-mode .depth-btn {
  border-color: #7EB8C8 !important;
}


/* PATCH: GA-Referenzen im Darkmode ohne Rahmen */
body.dark-mode .ga-reference {
  border: none !important;
  color: #7EB8C8 !important;
}


/* PATCH: GA-Referenzen ohne Hintergrund, ohne Rahmen und automatisch in Klammern */
.ga-reference {
  background: none !important;
  border: none !important;
  padding: 0 !important;
  color: #467886;
  font-weight: 600;
  text-decoration: none;
}

body.dark-mode .ga-reference {
  color: #7EB8C8 !important;
}

.ga-reference::before {
  content: "(";
}

.ga-reference::after {
  content: ")";
}


/* PATCH: Klammern im Darkmode in normaler heller Textfarbe */
body.dark-mode .ga-reference::before,
body.dark-mode .ga-reference::after {
  color: #e0e0e0 !important;
}


/* PATCH: Stichwortsuche – Abstand wie bei Themensuche */
#searchInfo {
  margin-top: 0.5rem !important;      /* vorher 0.3rem */
  padding-bottom: 0.5rem !important;  /* vorher 0.1rem */
}

</style>
<style>
select option.available-ga {
  font-weight: bold;
  color: black;
}
</style></head>
<body>
<div class="sidebar-toggle" onclick="toggleSidebar()">
<span id="sidebar-toggle-icon">◄</span>
</div>
<div id="sidebar">
<div id="sidebar-header">
<div style="display: flex; justify-content: space-between; align-items: center;">
<h1 id="site-title">GA Steiner Suche</h1>
<label class="theme-switch">
<input id="theme-checkbox" onchange="toggleThemeCheckbox()" type="checkbox"/>
<span class="theme-slider"></span>
</label>
</div>
<div class="tab-container">
<div class="tab-buttons">
<button class="tab-button active" onclick="switchTab('keyword')">Stichwort-Suche</button>
<button class="tab-button" onclick="switchTab('thematic')">Themen-Suche</button>
</div>
<div class="tab-content active" id="keyword-tab">
<div style="display:flex; gap:8px; margin-top:4px;">
<div style="flex:1; position: relative;">
<input class="search-input" id="word1" list="word1-history" onfocus="this.select()" oninput="updateProximityFilter()" onkeypress="handleKeywordKeypress(event)" placeholder="Suchwort 1" type="text"/>
<datalist id="word1-history"></datalist>
</div>
<div style="flex:1; position: relative;">
<input class="search-input" id="word2" list="word2-history" onfocus="this.select()" oninput="updateProximityFilter()" placeholder="Suchwort 2 (optional)" type="text"/>
<datalist id="word2-history"></datalist>
</div>
</div>
<div class="filter-row">
<select class="filter-dropdown" id="yearFilter">
<option value="">alle Jahre</option>
</select>
<select class="filter-dropdown" id="gaFilter">
<option value="">alle GA-Bände</option>
</select>
<select class="filter-dropdown" disabled="" id="proximityFilter">
<option value="">unbeschränkt</option>
<option value="1">ein Absatz</option>
<option value="2">zwei Absätze</option>
<option value="3">drei Absätze</option>
</select>
</div>
<div class="radio-group">
<label><input checked="" name="scope" type="radio" value="fulltext"/><span> Volltext</span></label>
<label><input name="scope" type="radio" value="title"/><span> Titel</span></label>
<button class="depth-btn primary" onclick="performKeywordSearch()" style="margin-left: auto; margin-bottom: 0;">Suche starten</button>
</div>
<span id="status" style="display:none"></span>
<div id="searchInfo" style="font-size: 0.9em; color: #666; margin-top: 0.3rem; margin-bottom: 0.1rem; padding-bottom: 0.1rem; border-bottom: 1px solid #ddd;">
<span id="serverInfo"></span>
<span id="resultInfo"></span>
</div>
</div>
<div class="tab-content" id="thematic-tab">
<textarea class="thematic-input" id="thematicQuery" onkeydown="handleThematicKeydown(event)" placeholder="Stellen Sie eine thematische Frage, z.B.:
• Wie sieht Steiner das Verhältnis von Kant zu Goethe?
• Welche Bedeutung hat Goethes Märchen für die Anthroposophie?
• Wie ist das Verhältnis von Ätherleib und Astralleib?"></textarea>
<div class="semantic-options">
<div class="filter-row">
<select class="filter-dropdown" id="thematicLimitFilter">
<option value="30">30 Quellen</option>
<option value="50">50 Quellen</option>
<option value="100">100 Quellen</option>
</select>
<select class="filter-dropdown" id="thematicGAFilter">
<option value="">Alle GA-Bände</option>
<option value="GA052">GA052</option>
<option value="GA058">GA058</option>
</select>
</div>
<div class="depth-buttons">
<button class="depth-btn active" data-depth="allgemein">Allgemein</button>
<button class="depth-btn" data-depth="ausführlich">Ausführlich</button>
<button class="depth-btn primary" id="thematicSearchBtn" onclick="performThematicSearch()" style="margin-left: auto;">
                Suche starten
              </button>
</div>
</div>
<div id="thematicSearchInfo" style="font-size: 0.9em; color: #666; margin-top: 0.5rem; margin-bottom: 0.3rem; padding-bottom: 0.5rem; border-bottom: 1px solid #ddd;">
<span id="thematicServerInfo"></span>
</div>
</div>
</div>
<div id="note" style="display: none;"></div>
</div>
<div id="sidebar-content">
<div id="results"></div>
</div>
</div>
<div class="resize-handle" id="resizeHandle"></div>
<div id="main-container">
<div id="main">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
<h2 id="document-title" style="margin: 0; flex: 1;">Bitte ein Ergebnis auswählen…</h2>
</div>
<div id="viewer"></div>
</div>
<div class="vertical-resize-handle" id="verticalResizeHandle"></div>
<div class="summary-panel-toggle" onclick="toggleSummaryPanel()">
<span id="summary-panel-toggle-icon">◄</span>
</div>
<div id="summary-panel">
<div class="summary-buttons">
<button class="search-button" disabled="" id="summaryCloseBtn" onclick="closeAndShowOriginal()">
          Original
        </button>
<button class="search-button" disabled="" id="regenerateBtn" onclick="regenerateSummary()">
          Neu
        </button>
<button class="search-button" disabled="" id="toggleH4Btn" onclick="toggleAllH4()">
          ∧
        </button>
</div>
<div id="summary-content">
<div id="toc-list"></div>
</div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    const API_BASE = 'https://ga-suche.onrender.com';
    let currentSources = [];
    let searchResults = [];
    let currentLectureData = null;
    let currentThematicQuery = '';
    let searchHistory = {
      word1: [],
      word2: []
    };
    let showingSummaryInMain = false;
    let currentLectureSummary = null;
    let lastHighlightedIndex = null;

    function addToHistory(field, value) {
      if (!value || !value.trim()) return;
      
      const trimmed = value.trim();
      
      searchHistory[field] = searchHistory[field].filter(item => item !== trimmed);
      searchHistory[field].unshift(trimmed);
      searchHistory[field] = searchHistory[field].slice(0, 10);
      
      updateHistoryDatalist();
    }

    function updateHistoryDatalist() {
      const word1List = document.getElementById('word1-history');
      const word2List = document.getElementById('word2-history');
      
      if (word1List) {
        word1List.innerHTML = searchHistory.word1.map(item => 
          `<option value="${item}">`
        ).join('');
      }
      
      if (word2List) {
        word2List.innerHTML = searchHistory.word2.map(item => 
          `<option value="${item}">`
        ).join('');
      }
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const icon = document.getElementById('sidebar-toggle-icon');
      
      if (sidebar.classList.contains('collapsed')) {
        sidebar.classList.remove('collapsed');
        sidebar.style.width = '';
        sidebar.style.minWidth = '';
        icon.textContent = '◄';
        setTimeout(updateTogglePosition, 50);
      } else {
        sidebar.classList.add('collapsed');
        sidebar.style.width = '0';
        sidebar.style.minWidth = '0';
        icon.textContent = '►';
      }
    }

    function switchTab(mode) {
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`[onclick="switchTab('${mode}')"]`).classList.add('active');
      
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(`${mode}-tab`).classList.add('active');
    }

    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.depth-btn[data-depth]').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.depth-btn[data-depth]').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
        });
      });
      
      populateYearFilter();
      populateGAFilters();
      initResizeHandle();
      initVerticalResizeHandle();
      checkServerConnection();
      initTheme();
    });

    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      const checkbox = document.getElementById('theme-checkbox');
      if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        if (checkbox) checkbox.checked = true;
      }
    }

    function toggleThemeCheckbox() {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    function populateYearFilter() {
      const yearFilter = document.getElementById('yearFilter');
      
      for (let year = 1882; year <= 1925; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearFilter.appendChild(option);
      }
    }

    function populateGAFilters() {
      const gaFilter = document.getElementById('gaFilter');
      const thematicGAFilter = document.getElementById('thematicGAFilter');
      
      gaFilter.innerHTML = '<option value="">alle GA-Bände</option>';
      thematicGAFilter.innerHTML = '<option value="">alle GA-Bände</option>';
      
      for (let num = 1; num <= 400; num++) {
        const gaNumber = 'GA' + String(num).padStart(3, '0');
        
        const option1 = document.createElement('option');
        option1.value = gaNumber;
        option1.textContent = gaNumber;
        gaFilter.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = gaNumber;
        option2.textContent = gaNumber;
        thematicGAFilter.appendChild(option2);
      }
    }

    async function checkServerConnection() {
      try {
        const response = await fetch(`${API_BASE}/debug/status`);
        if (response.ok) {
          const data = await response.json();
          const infoText = `${data.lecturesLoaded} Vorträge verfügbar`;
          document.getElementById('serverInfo').textContent = infoText;
          document.getElementById('thematicServerInfo').textContent = infoText;
        }
      } catch (error) {
        const errorText = `<span style="color: #c53030;">Server nicht erreichbar</span>`;
        document.getElementById('serverInfo').innerHTML = errorText;
        document.getElementById('thematicServerInfo').innerHTML = errorText;
      }
    }

    function updateProximityFilter() {
      const word1 = document.getElementById('word1').value.trim();
      const word2 = document.getElementById('word2').value.trim();
      const proximityFilter = document.getElementById('proximityFilter');
      
      if (word1 && word2) {
        proximityFilter.disabled = false;
      } else {
        proximityFilter.disabled = true;
        proximityFilter.selectedIndex = 0;
      }
    }

    async function performKeywordSearch() {
      const word1Input = document.getElementById('word1').value.trim();
      const word2Input = document.getElementById('word2').value.trim();
      
      if (!word1Input && !word2Input) {
        alert('Bitte mindestens ein Suchwort eingeben');
        return;
      }
      
      document.getElementById('viewer').innerHTML = '';
      document.getElementById('document-title').textContent = 'Bitte ein Ergebnis auswählen…';
      
      if (word1Input) addToHistory('word1', word1Input);
      if (word2Input) addToHistory('word2', word2Input);
      
      const word1 = word1Input || word2Input;
      const word2 = word1Input && word2Input ? word2Input : null;
      
      const button = document.querySelector('#keyword-tab .depth-btn.primary');
      
      try {
        button.disabled = true;
        button.classList.add('processing');
        button.textContent = 'Suche läuft...';
        
        
        const gaFilter = document.getElementById('gaFilter').value;
        const proximityFilter = document.getElementById('proximityFilter').value;
        
        const response = await fetch(`${API_BASE}/api/fulltext-search`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            word1: word1,
            word2: word2,
            proximity: proximityFilter || null
          })
        });
        
        if (!response.ok) throw new Error(`Server Error: ${response.status}`);
        
        const data = await response.json();
        let results = data.results;
        
        console.log(`Volltext-Suche: ${results.length} Absätze gefunden`);
        
        if (gaFilter) {
          results = results.filter(r => r.ID && r.ID.startsWith(gaFilter));
        }
        
        searchResults = results;
        const displayQuery = word1Input && word2Input ? `${word1Input} + ${word2Input}` : (word1Input || word2Input);
        renderKeywordResults(displayQuery, results, word1Input, word2Input);
        
        document.getElementById('resultInfo').textContent = ` • ${results.length} Treffer`;
        
      } catch (error) {
        console.error('Keyword-Suche Fehler:', error);
        document.getElementById('results').innerHTML = `
          <div class="error-message">
            <strong>Fehler bei der Suche:</strong><br>${error.message}
          </div>
        `;
      } finally {
        button.disabled = false;
        button.classList.remove('processing');
        button.textContent = 'Suche starten';
        
      }
    }

    function extractDateFromFileName(fileName) {
      if (!fileName) return '';
      
      const monthNames = {
        'januar': '01', 'februar': '02', 'märz': '03', 'april': '04',
        'mai': '05', 'juni': '06', 'juli': '07', 'august': '08',
        'september': '09', 'oktober': '10', 'november': '11', 'dezember': '12'
      };
      
      let dateMatch = fileName.match(/(\d{1,2})\.\s+([a-zä]+)\s+(\d{4})/i);
      
      if (dateMatch) {
        const day = dateMatch[1].padStart(2, '0');
        const monthName = dateMatch[2].toLowerCase();
        const year = dateMatch[3];
        const month = monthNames[monthName] || '00';
        
        return `${year}-${month}-${day}`;
      }
      
      dateMatch = fileName.match(/im\s+([a-zä]+)\s+(\d{4})/i);
      if (dateMatch) {
        const monthName = dateMatch[1].toLowerCase();
        const year = dateMatch[2];
        const month = monthNames[monthName] || '00';
        
        return `${year}-${month}-01`;
      }
      
      dateMatch = fileName.match(/(\d{4})/);
      if (dateMatch) {
        return `${dateMatch[1]}-00-00`;
      }
      
      return '';
    }

    function renderKeywordResults(query, results, word1, word2) {
      const container = document.getElementById('results');
      const scope = document.querySelector('input[name="scope"]:checked').value;
      
      if (results.length === 0) {
        container.innerHTML = '<p><em>Keine Treffer gefunden.</em></p>';
        return;
      }
      
      const list = document.createElement('ul');
      list.className = 'results-list';
      list.style.marginTop = '0';
      list.style.paddingTop = '0.5rem';
      
      const groupedByLecture = {};
      results.forEach(result => {
        const lectureId = result.ID;
        if (!groupedByLecture[lectureId]) {
          let lectureDate = result.date || '';
          if (!lectureDate && result.fileName) {
            lectureDate = extractDateFromFileName(result.fileName);
          }
          
          groupedByLecture[lectureId] = {
            fileName: result.fileName || result.title,
            date: lectureDate,
            chunks: []
          };
        }
        groupedByLecture[lectureId].chunks.push(result);
      });
      
      const sortedLectures = Object.entries(groupedByLecture).sort((a, b) => {
        const dateA = a[1].date || '';
        const dateB = b[1].date || '';
        return dateA.localeCompare(dateB);
      });
      
      sortedLectures.forEach(([lectureId, lecture]) => {
        const li = document.createElement('li');
        
        const titleLink = document.createElement('a');
        titleLink.href = "#";
        titleLink.textContent = lecture.fileName;
        titleLink.addEventListener('click', (e) => {
          e.preventDefault();
          showLectureTop(lectureId);
        });
        
        li.appendChild(titleLink);
        
        if (scope === "fulltext") {
          const proximityFilter = document.getElementById('proximityFilter').value;
          
          let lectureChunks = lecture.chunks;
          
          if (word1 && word2 && proximityFilter && proximityFilter !== '') {
            lectureChunks = lecture.chunks.filter(chunk => {
              const contentLower = (chunk.content || '').toLowerCase();
              return contentLower.includes(word1.toLowerCase()) && 
                     contentLower.includes(word2.toLowerCase());
            });
          }
          
          lectureChunks.slice(0, 5).forEach(chunk => {
            const snippetDiv = document.createElement("div");
            snippetDiv.className = "snippet";
            
            const content = chunk.content || '';
            
            let snippet = '';
            let foundPosition = -1;
            let foundWord = null;
            
            const contentLower = content.toLowerCase();
            const positions = [];
            
            if (word1 && word1.trim()) {
              const pos = contentLower.indexOf(word1.toLowerCase());
              if (pos !== -1) positions.push({ pos, word: word1 });
            }
            
            if (word2 && word2.trim()) {
              const pos = contentLower.indexOf(word2.toLowerCase());
              if (pos !== -1) positions.push({ pos, word: word2 });
            }
            
            if (positions.length > 0) {
              positions.sort((a, b) => a.pos - b.pos);
              foundPosition = positions[0].pos;
              foundWord = positions[0].word;
            }
            
            if (foundPosition !== -1 && content) {
              const start = Math.max(0, foundPosition - 200);
              const end = Math.min(content.length, foundPosition + foundWord.length + 200);
              
              snippet = (start > 0 ? '...' : '') + 
                        content.substring(start, end) + 
                        (end < content.length ? '...' : '');
              
              if (word1 && word1.trim()) {
                const regex = new RegExp(`(${word1.trim()})`, "gi");
                snippet = snippet.replace(regex, "<mark>$1</mark>");
              }
              
              if (word2 && word2.trim()) {
                const regex = new RegExp(`(${word2.trim()})`, "gi");
                snippet = snippet.replace(regex, "<mark>$1</mark>");
              }
              
              snippetDiv.innerHTML = snippet;
              snippetDiv.style.cursor = 'pointer';
              snippetDiv.setAttribute('data-lecture-id', lectureId);
              snippetDiv.setAttribute('data-chunk-index', chunk.index);
              snippetDiv.addEventListener("click", function(e) {
                e.preventDefault();
                e.stopPropagation();
                const currentWord1 = document.getElementById('word1').value.trim();
                const currentWord2 = document.getElementById('word2').value.trim();
                const keywords = [currentWord1, currentWord2].filter(w => w && w.trim());
                const lecId = e.currentTarget.getAttribute('data-lecture-id');
                const chunkIdx = e.currentTarget.getAttribute('data-chunk-index');
                
                showingSummaryInMain = false;
                
                // Schließe Summary Panel wenn es offen ist
                const summaryPanel = document.getElementById('summary-panel');
                const resizeHandle = document.getElementById('verticalResizeHandle');
                const icon = document.getElementById('summary-panel-toggle-icon');
                if (summaryPanel.classList.contains('visible')) {
                  summaryPanel.classList.remove('visible');
                  resizeHandle.classList.remove('visible');
                  icon.textContent = '◄';
                  summaryPanel.style.width = '0';
                  summaryPanel.style.minWidth = '0';
                  summaryPanel.style.marginRight = '24px';
                }
                
                showLecture(lecId, chunkIdx, keywords);
              });
              li.appendChild(snippetDiv);
            }
          });
        }
        
        list.appendChild(li);
      });
      
      container.innerHTML = '';
      container.appendChild(list);
      
      const lectureCount = sortedLectures.length;
      const chunkCount = results.length;
      document.getElementById('status').textContent = `${lectureCount} Vorträge mit ${chunkCount} Treffern`;
    }

    async function performThematicSearch() {
      const query = document.getElementById('thematicQuery').value.trim();
      if (!query) return;
      
      currentThematicQuery = query;
      
      const button = document.getElementById('thematicSearchBtn');
      const originalText = button.textContent;
      
      try {
        button.disabled = true;
        button.classList.add('processing');
        button.textContent = 'Suche läuft...';
        
        const depth = document.querySelector('.depth-btn.active').dataset.depth;
        const limit = document.getElementById('thematicLimitFilter').value;
        const gaFilter = document.getElementById('thematicGAFilter').value;
        
        const response = await fetch(`${API_BASE}/api/thematic-hybrid-search`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query: query,
            depth: depth,
            limit: parseInt(limit)
          })
        });
        
        if (!response.ok) throw new Error(`Server Error: ${response.status}`);
        
        const answer = await response.json();
        let sources = answer.sources || [];
        
        if (gaFilter) {
          sources = sources.filter(source => source.ID && source.ID.startsWith(gaFilter));
        }
        
        currentSources = sources;
        renderThematicResults(query, answer.content, sources);
        
      } catch (error) {
        console.error('Thematic Search Error:', error);
        document.getElementById('results').innerHTML = `
          <div class="error-message">
            <strong>Fehler bei der Themen-Suche:</strong><br>${error.message}
          </div>
        `;
      } finally {
        button.disabled = false;
        button.classList.remove('processing');
        button.textContent = 'Suche starten';
        
      }
    }

    function updateButtonStates() {
      const closeBtn = document.getElementById('summaryCloseBtn');
      const regenerateBtn = document.getElementById('regenerateBtn');
      const toggleH4Btn = document.getElementById('toggleH4Btn');
      
      if (closeBtn && currentLectureData) {
        closeBtn.disabled = false;
      }
      
      if (regenerateBtn && currentLectureData && currentLectureSummary) {
        // Button nur aktivieren wenn keine H4-Überschriften vorhanden sind
        const hasH4 = currentLectureSummary.headings?.some(h => h.level === 'h4');
        regenerateBtn.disabled = hasH4;
        if (hasH4) {
          regenerateBtn.style.opacity = '0.5';
          regenerateBtn.title = 'Vortrag hat bereits H4-Überschriften';
        } else {
          regenerateBtn.style.opacity = '1';
          regenerateBtn.title = '';
        }
      }
      
      if (toggleH4Btn && currentLectureData) {
        toggleH4Btn.disabled = false;
      }
    }

    let h4Collapsed = false;

    function toggleAllH4() {
      const toggleBtn = document.getElementById('toggleH4Btn');
      const tocList = document.getElementById('toc-list');
      const viewer = document.getElementById('viewer');
      
      if (!tocList) return;
      
      const tocH4 = tocList.querySelectorAll('h4');
      const viewerH4 = viewer.querySelectorAll('h4');
      
      h4Collapsed = !h4Collapsed;
      
      // Toggle im TOC
      tocH4.forEach(h4 => {
        if (h4Collapsed) {
          h4.classList.add('hidden');
        } else {
          h4.classList.remove('hidden');
        }
      });
      
      // Toggle im Viewer
      viewerH4.forEach(h4 => {
        if (h4Collapsed) {
          h4.style.display = 'none';
        } else {
          h4.style.display = 'block';
        }
      });
      
      if (toggleBtn) {
        toggleBtn.innerHTML = h4Collapsed ? '&#x2228;' : '&#x2227;'; // ∨ für ausklappen, ∧ für einklappen
      }
    }

    async function toggleSummaryPanel() {
      const panel = document.getElementById('summary-panel');
      const icon = document.getElementById('summary-panel-toggle-icon');
      const resizeHandle = document.getElementById('verticalResizeHandle');
      const toggle = document.querySelector('.summary-panel-toggle');
      
      toggle.style.right = '0px';
      toggle.style.position = 'fixed';
      
      if (panel.classList.contains('visible')) {
        panel.classList.remove('visible');
        resizeHandle.classList.remove('visible');
        icon.textContent = '◄';
        panel.style.width = '0';
        panel.style.minWidth = '0';
        panel.style.marginRight = '24px';
      } else {
        if (!currentLectureData) {
          alert('Bitte zuerst einen Vortrag laden');
          return;
        }
        
        panel.classList.add('visible');
        resizeHandle.classList.add('visible');
        icon.textContent = '►';
        panel.style.width = '280px';
        panel.style.minWidth = '280px';
        panel.style.marginRight = '24px';
        
        await loadSummaryAutomatically();
      }
      
      setTimeout(() => {
        toggle.style.right = '0px';
        toggle.style.position = 'fixed';
      }, 0);
    }

    async function loadSummaryAutomatically() {
      const closeBtn = document.getElementById('summaryCloseBtn');
      const regenerateBtn = document.getElementById('regenerateBtn');
      const tocList = document.getElementById('toc-list');
      
      if (!currentLectureSummary) {
        try {
          closeBtn.disabled = true;
          regenerateBtn.disabled = true;
          tocList.innerHTML = '<p style="padding: 1rem; color: #666; font-style: italic;">bitte warten...</p>';
          
          const response = await fetch(`${API_BASE}/api/summarize-lecture`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              lectureId: currentLectureData.ID,
              forceRegenerate: false
            })
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `Server Error: ${response.status}`);
          }
          
          const data = await response.json();
          
          currentLectureSummary = {
            summary: data.summary,
            headings: data.headings || []
          };
        } catch (error) {
          console.error('Zusammenfassungs-Fehler:', error);
          tocList.innerHTML = `<p style="padding: 1rem; color: #c53030;">Fehler: ${error.message}</p>`;
          closeBtn.disabled = false;
          regenerateBtn.disabled = false;
          return;
        }
      }
      
      const visibleIndex = getCurrentVisibleParagraphIndex();
      if (visibleIndex) {
        lastHighlightedIndex = visibleIndex;
      }
      
      showingSummaryInMain = true;
      displaySummaryWithHeadings(currentLectureData, currentLectureSummary);
      buildTableOfContents();
      
      closeBtn.disabled = false;
      
      // Regenerate-Button nur aktivieren wenn keine H4-Überschriften vorhanden sind
      const hasH4 = currentLectureSummary.headings?.some(h => h.level === 'h4');
      regenerateBtn.disabled = hasH4;
      if (hasH4) {
        regenerateBtn.style.opacity = '0.5';
        regenerateBtn.title = 'Vortrag hat bereits H4-Überschriften';
      } else {
        regenerateBtn.style.opacity = '1';
        regenerateBtn.title = '';
      }
      
      if (lastHighlightedIndex) {
        scrollToIndexInViewer(lastHighlightedIndex);
      }
    }

    async function regenerateSummary() {
      if (!currentLectureData) {
        alert('Kein Vortrag geladen');
        return;
      }
      
      const confirm = window.confirm('Zusammenfassung neu generieren? Dies kann einige Minuten dauern.');
      if (!confirm) return;
      
      const closeBtn = document.getElementById('summaryCloseBtn');
      const regenerateBtn = document.getElementById('regenerateBtn');
      const tocList = document.getElementById('toc-list');
      
      try {
        closeBtn.disabled = true;
        regenerateBtn.disabled = true;
        regenerateBtn.classList.add('processing');
        regenerateBtn.textContent = 'bitte warten...';
        tocList.innerHTML = '<p style="padding: 1rem; color: #666; font-style: italic;">neu generieren...</p>';
        
        const response = await fetch(`${API_BASE}/api/summarize-lecture`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            lectureId: currentLectureData.ID,
            forceRegenerate: true
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `Server Error: ${response.status}`);
        }
        
        const data = await response.json();
        
        currentLectureSummary = {
          summary: data.summary,
          headings: data.headings || []
        };
        
        console.log('Neue Zusammenfassung generiert');
        
        const visibleIndex = getCurrentVisibleParagraphIndex();
        if (visibleIndex) {
          lastHighlightedIndex = visibleIndex;
        }
        
        showingSummaryInMain = true;
        displaySummaryWithHeadings(currentLectureData, currentLectureSummary);
        buildTableOfContents();
        
        if (lastHighlightedIndex) {
          scrollToIndexInViewer(lastHighlightedIndex);
        }
        
      } catch (error) {
        console.error('Regenerierungs-Fehler:', error);
        tocList.innerHTML = `<p style="padding: 1rem; color: #c53030;">Fehler: ${error.message}</p>`;
      } finally {
        closeBtn.disabled = false;
        regenerateBtn.disabled = false;
        regenerateBtn.classList.remove('processing');
        regenerateBtn.textContent = 'Neu';
      }
    }

    function closeAndShowOriginal() {
      const panel = document.getElementById('summary-panel');
      const icon = document.getElementById('summary-panel-toggle-icon');
      const resizeHandle = document.getElementById('verticalResizeHandle');
      const toggle = document.querySelector('.summary-panel-toggle');
      
      panel.classList.remove('visible');
      resizeHandle.classList.remove('visible');
      icon.textContent = '◄';
      panel.style.width = '0';
      panel.style.minWidth = '0';
      panel.style.marginRight = '24px';
      
      toggle.style.right = '0px';
      toggle.style.position = 'fixed';
      
      const visibleIndex = getCurrentVisibleParagraphIndex();
      if (visibleIndex) {
        lastHighlightedIndex = visibleIndex;
      }
      
      showingSummaryInMain = false;
      
      const currentWord1 = document.getElementById('word1').value.trim();
      const currentWord2 = document.getElementById('word2').value.trim();
      let keywords = [currentWord1, currentWord2].filter(w => w && w.trim());
      if (keywords.length === 0 && currentThematicQuery) {
        keywords = extractKeywordsFromQuery(currentThematicQuery);
      }
      
      displayLecture(currentLectureData, lastHighlightedIndex, keywords, false);
      
      if (lastHighlightedIndex) {
        scrollToIndexInViewer(lastHighlightedIndex);
      }
      
      setTimeout(() => {
        toggle.style.right = '0px';
        toggle.style.position = 'fixed';
      }, 0);
    }

    function getCurrentVisibleParagraphIndex() {
      const mainContainer = document.getElementById('main');
      const allParagraphs = document.querySelectorAll('[id^="para-"]');
      
      if (allParagraphs.length === 0) return null;
      
      const containerTop = mainContainer.getBoundingClientRect().top;
      
      for (let para of allParagraphs) {
        const paraRect = para.getBoundingClientRect();
        const relativeTop = paraRect.top - containerTop;
        
        if (relativeTop >= -50 && relativeTop <= 100) {
          return para.id.replace('para-', '');
        }
      }
      
      return allParagraphs[0].id.replace('para-', '');
    }

    function scrollToIndexInViewer(targetIndex) {
      if (!targetIndex) return;
      
      const mainContainer = document.getElementById('main');
      const paraElement = document.getElementById(`para-${targetIndex}`);
      
      if (paraElement) {
        const mainRect = mainContainer.getBoundingClientRect();
        const paraRect = paraElement.getBoundingClientRect();
        const relativeTop = paraRect.top - mainRect.top + mainContainer.scrollTop;
        mainContainer.scrollTop = relativeTop;
      }
    }

    function displaySummaryWithHeadings(lecture, summaryObj) {
      const viewer = document.getElementById('viewer');
      
      const currentWord1 = document.getElementById('word1').value.trim();
      const currentWord2 = document.getElementById('word2').value.trim();
      let keywords = [];
      
      if ((currentWord1 || currentWord2) && searchResults.length > 0) {
        const isFromCurrentSearch = searchResults.some(result => result.ID === lecture.ID);
        if (isFromCurrentSearch) {
          keywords = [currentWord1, currentWord2].filter(w => w && w.trim());
        }
      }
      
      let html = '';
      
      html += '<div style="margin-bottom: 2rem;">';
      html += '<p><strong>Zusammenfassung</strong></p>';
      html += `<p style="font-style: italic;">${summaryObj.summary}</p>`;
      html += '<hr style="margin: 2rem 0; border: none; border-top: 1px solid #ddd;">';
      html += '</div>';
      
      const headings = summaryObj.headings || [];
      const paragraphs = lecture.paragraphs || [];
      
      paragraphs.forEach((para, idx) => {
        const paraIndex = para.index ? para.index.replace(/^\^/, '') : `para_${idx}`;
        const paraIndexWithCaret = para.index || `^${paraIndex}`;
        
        // Debug: Log für ersten Absatz
        if (idx === 0) {
          console.log('Erster Absatz Index:', paraIndex, 'mit ^:', paraIndexWithCaret);
          console.log('Alle heading indices:', headings.map(h => h.index));
        }
        
        // Finde ALLE Überschriften für diesen Index (mit verschiedenen Varianten)
        const matchingHeadings = headings.filter(h => {
          const hIndex = h.index || '';
          const hIndexClean = hIndex.replace(/^\^/, '');
          return hIndex === paraIndex || 
                 hIndex === paraIndexWithCaret || 
                 hIndexClean === paraIndex;
        });
        
        if (matchingHeadings.length > 0 && idx < 5) {
          console.log(`Absatz ${idx} (${paraIndex}): ${matchingHeadings.length} Überschriften gefunden`);
        }
        
        // Sortiere: H3 vor H4
        matchingHeadings
          .sort((a, b) => {
            if (a.level === 'h3' && b.level === 'h4') return -1;
            if (a.level === 'h4' && b.level === 'h3') return 1;
            return 0;
          })
          .forEach((heading, hIdx) => {
            const headingText = heading.text || heading.title || 'Überschrift';
            const level = heading.level || 'h3';
            
            if (level === 'h3') {
              html += `<h3 id="heading-${idx}-${hIdx}">${headingText}</h3>`;
            } else if (level === 'h4') {
              html += `<h4 id="heading-${idx}-${hIdx}">${headingText}</h4>`;
            }
          });
        
        let content = para.content || para.text || '';
        
        if (keywords && keywords.length > 0) {
          keywords.forEach(word => {
            if (word && word.trim()) {
              const regex = new RegExp(`(${word.trim()})`, "gi");
              content = content.replace(regex, "<mark>$1</mark>");
            }
          });
        }
        
        html += `<div class="paragraph" id="para-${paraIndex}" data-array-index="${idx}">${content}</div>`;
      });
      
      viewer.innerHTML = html;
    }

    function extractKeywordsFromQuery(query) {
      const stopWords = [
        'wie', 'ist', 'das', 'verhältnis', 'von', 'und', 'der', 'die', 'des', 
        'den', 'dem', 'ein', 'eine', 'einem', 'einen', 'was', 'welche', 'welcher',
        'zwischen', 'bei', 'nach', 'für', 'mit', 'aus', 'über', 'sich', 'zur',
        'steiner', 'rudolf', 'sieht', 'kritisiert', 'spielt', 'rolle'
      ];
      
      const words = query.toLowerCase()
        .replace(/[.,;:!?]/g, ' ')
        .split(/\s+/)
        .filter(word => word.length > 3 && !stopWords.includes(word));
      
      return words;
    }

    function renderThematicResults(query, content, sources) {
      const container = document.getElementById('results');
      
      const sortedSources = [...sources].sort((a, b) => {
        const dateA = a.date || '';
        const dateB = b.date || '';
        return dateA.localeCompare(dateB);
      });
      
      container.innerHTML = `
        <div class="semantic-answer">
          <div class="answer-content" id="answerContent"></div>
        </div>
      `;
      
      const answerDiv = document.getElementById('answerContent');
      answerDiv.innerHTML = marked.parse(content);
      
      document.getElementById('status').textContent = `Antwort aus ${sortedSources.length} Quellen`;
      
      setTimeout(() => {
        const gaLinks = answerDiv.querySelectorAll('.ga-reference');
        
        gaLinks.forEach(link => {
          const lectureId = link.getAttribute('data-id');
          const targetIndex = link.getAttribute('data-index');
          
          if (lectureId && targetIndex) {
            link.addEventListener('click', (e) => {
              e.preventDefault();
              const keywords = extractKeywordsFromQuery(currentThematicQuery);
              showLecture(lectureId, targetIndex, keywords);
            });
          }
        });
      }, 100);
    }

    async function showLectureTop(lectureId) {
      await showLecture(lectureId, null, []);
    }

    async function showLecture(lectureId, targetIndex, keywords = []) {

      // Panel bei neuem Vortrag immer schließen
      const summaryPanel = document.getElementById('summary-panel');
      const resizeHandle = document.getElementById('verticalResizeHandle');
      const tocList = document.getElementById('toc-list');
      if (summaryPanel.classList.contains('visible')) {
        summaryPanel.classList.remove('visible');
        resizeHandle.classList.remove('visible');
        summaryPanel.style.width = '0';
        summaryPanel.style.minWidth = '0';
        summaryPanel.style.marginRight = '24px';
        if (tocList) tocList.innerHTML = '';
      }

      try {
        
        
        const summaryPanel = document.getElementById('summary-panel');
        const resizeHandle = document.getElementById('verticalResizeHandle');
        const tocList = document.getElementById('toc-list');
        
        if (summaryPanel.classList.contains('visible')) {
          summaryPanel.classList.remove('visible');
          resizeHandle.classList.remove('visible');
        }
        
        if (tocList) tocList.innerHTML = '';
        
        const parts = lectureId.split('/');
        const url = parts.length === 2 
          ? `${API_BASE}/api/full-lecture/${parts[0]}/${parts[1]}`
          : `${API_BASE}/api/full-lecture/${lectureId}`;
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`Vortrag nicht gefunden: ${lectureId}`);
        }
        
        const data = await response.json();
        currentLectureData = data.lecture;
        
        currentLectureSummary = null;
        showingSummaryInMain = false;
        
        let displayKeywords = keywords;
        if (!displayKeywords || displayKeywords.length === 0) {
          const currentWord1 = document.getElementById('word1').value.trim();
          const currentWord2 = document.getElementById('word2').value.trim();
          if (currentWord1 || currentWord2) {
            displayKeywords = [currentWord1, currentWord2].filter(w => w && w.trim());
          }
          else if (currentThematicQuery) {
            displayKeywords = extractKeywordsFromQuery(currentThematicQuery);
          }
        }
        
        updateButtonStates();
        
        displayLecture(data.lecture, targetIndex, displayKeywords);
        
      } catch (error) {
        console.error('Fehler beim Laden:', error);
        document.getElementById('viewer').innerHTML = `
          <div class="error-message">
            <strong>Fehler beim Laden des Vortrags:</strong><br>${error.message}
          </div>
        `;
      } finally {
        
      }
    }

    function buildTableOfContents() {
      const viewer = document.getElementById('viewer');
      const tocList = document.getElementById('toc-list');
      const mainContainer = document.getElementById('main');
      
      // Suche nach H3 und H4
      const headings = viewer.querySelectorAll('h3, h4');
      
      tocList.innerHTML = '';
      
      let headingIndex = 0;
      const tocItems = [];
      
      // Reset collapse state
      h4Collapsed = false;
      const toggleBtn = document.getElementById('toggleH4Btn');
      if (toggleBtn) {
        toggleBtn.innerHTML = '&#x2227;'; // ∧ für einklappen
      }
      
      headings.forEach((heading) => {
        if (!heading.id) {
          heading.id = `heading-${headingIndex}`;
        }
        headingIndex++;
        
        const tocHeading = document.createElement(heading.tagName.toLowerCase());
        tocHeading.textContent = heading.textContent;
        tocHeading.style.cursor = 'pointer';
        
        tocHeading.addEventListener('click', (e) => {
          e.preventDefault();
          heading.scrollIntoView({ behavior: 'auto', block: 'start' });
          
          const originalBg = heading.style.backgroundColor;
          heading.style.backgroundColor = 'rgba(70, 120, 134, 0.2)';
          setTimeout(() => {
            heading.style.backgroundColor = originalBg;
          }, 1000);
        });
        
        tocList.appendChild(tocHeading);
        tocItems.push({ element: tocHeading, heading: heading });
      });
      
      function updateActiveTocItem() {
        const containerTop = mainContainer.getBoundingClientRect().top;
        const scrollTop = mainContainer.scrollTop;
        
        let activeHeading = null;
        let activeTocItem = null;
        
        // Wenn H4s eingeklappt sind, suche nur nach H3s
        const selector = h4Collapsed ? 'h3' : 'h3, h4';
        const visibleHeadings = Array.from(viewer.querySelectorAll(selector));
        
        // Finde die letzte Überschrift, die oberhalb oder bei der Scroll-Position ist
        for (let i = visibleHeadings.length - 1; i >= 0; i--) {
          const heading = visibleHeadings[i];
          const headingRect = heading.getBoundingClientRect();
          const relativeTop = headingRect.top - containerTop;
          
          if (relativeTop <= 50) {
            activeHeading = heading;
            break;
          }
        }
        
        // Entferne alle Markierungen
        tocItems.forEach(item => {
          item.element.style.fontWeight = 'normal';
          item.element.style.color = '#467886';
        });
        
        if (!activeHeading) return;
        
        // Finde das TOC-Element für das aktive Heading
        for (let i = 0; i < tocItems.length; i++) {
          if (tocItems[i].heading === activeHeading) {
            activeTocItem = tocItems[i].element;
            break;
          }
        }
        
        // Markiere das gefundene TOC-Element
        if (activeTocItem) {
          activeTocItem.style.fontWeight = 'bold';
          activeTocItem.style.color = '#467886';
        }
      }
      
      mainContainer.removeEventListener('scroll', updateActiveTocItem);
      mainContainer.addEventListener('scroll', updateActiveTocItem);
      
      updateActiveTocItem();
    }

    function createOnlineURL(lecture) {
      if (!lecture.fileName) {
        return `https://rudolf-steiner-online.de/${lecture.ID || ''}`;
      }
      
      const fileName = lecture.fileName;
      const match = fileName.match(/^(GA\d{3}[a-z]?)\/(\d+)\s*-\s*(.+)$/);
      
      if (!match) {
        return `https://rudolf-steiner-online.de/${lecture.ID || ''}`;
      }
      
      const [, gaNumber, lectureNumber, rest] = match;
      
      const titleForUrl = rest.replace(/ /g, '+');
      const encodedTitle = encodeURIComponent(titleForUrl).replace(/%2B/g, '+');
      
      return `https://rudolf-steiner-online.de/${gaNumber}+(${lectureNumber}.)+${encodedTitle}`;
    }

    function displayLecture(lecture, highlightIndex, keywords = [], shouldHighlight = true) {
      const viewer = document.getElementById('viewer');
      const mainContainer = document.getElementById('main');
      const titleElement = document.getElementById('document-title');
      
      const cleanIndex = highlightIndex ? highlightIndex.replace(/^\^/, '') : null;
      
      viewer.innerHTML = '';
      
      const displayTitle = lecture.fileName || lecture.title || lecture.ID;
      const onlineLink = createOnlineURL(lecture);
      
      titleElement.innerHTML = `<a href="${onlineLink}" target="rudolf-steiner-online">${displayTitle}</a>`;
      
      let html = '<div>';
      
      if (lecture.paragraphs) {
        lecture.paragraphs.forEach((para, idx) => {
          const paraIndex = para.index ? para.index.replace(/^\^/, '') : `para_${idx}`;
          const isTargetPara = cleanIndex && paraIndex === cleanIndex;
          
          let content = para.content || para.text || '';
          
          if (keywords && keywords.length > 0) {
            keywords.forEach(word => {
              if (word && word.trim()) {
                const regex = new RegExp(`(${word.trim()})`, "gi");
                content = content.replace(regex, "<mark>$1</mark>");
              }
            });
          }
          
          const contentLower = content.toLowerCase();
          const hasBothWords = keywords.length === 2 && 
                               keywords[0] && keywords[1] &&
                               contentLower.includes(keywords[0].toLowerCase()) && 
                               contentLower.includes(keywords[1].toLowerCase());
          
          const applyHighlight = shouldHighlight && isTargetPara && (keywords.length === 1 || hasBothWords);
          
          html += `
            <div class="paragraph ${applyHighlight ? 'highlighted-paragraph' : ''}" 
                 id="para-${paraIndex}">
              ${content}
            </div>
          `;
        });
      }
      
      html += `</div>`;
      viewer.innerHTML = html;
      
      if (cleanIndex) {
        const targetElement = document.getElementById(`para-${cleanIndex}`);
        if (targetElement) {
          const mainRect = mainContainer.getBoundingClientRect();
          const targetRect = targetElement.getBoundingClientRect();
          const relativeTop = targetRect.top - mainRect.top + mainContainer.scrollTop;
          mainContainer.scrollTop = relativeTop;
          lastHighlightedIndex = cleanIndex;
        } else {
          mainContainer.scrollTop = 0;
        }
      } else {
        mainContainer.scrollTop = 0;
      }
      
      updateButtonStates();
    }

    function handleKeywordKeypress(event) {
      if (event.key === 'Enter') {
        performKeywordSearch();
      }
    }

    function handleThematicKeydown(event) {
      if (event.ctrlKey && event.key === 'Enter') {
        performThematicSearch();
      }
    }

    function updateTogglePosition() {
      const sidebar = document.getElementById('sidebar');
      const toggle = document.querySelector('.sidebar-toggle');
      
      if (!sidebar.classList.contains('collapsed')) {
        const sidebarWidth = sidebar.offsetWidth;
        toggle.style.left = (sidebarWidth - 2) + 'px';
      }
    }

    function initResizeHandle() {
      const resizeHandle = document.getElementById('resizeHandle');
      const sidebar = document.getElementById('sidebar');
      let isResizing = false;

      resizeHandle.addEventListener('mousedown', function(e) {
        isResizing = true;
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        e.preventDefault();
      });

      function handleMouseMove(e) {
        if (!isResizing) return;
        
        const containerWidth = document.body.clientWidth;
        const newSidebarWidth = (e.clientX / containerWidth) * 100;
        
        if (newSidebarWidth >= 15 && newSidebarWidth <= 90) {
          const pixelWidth = (newSidebarWidth / 100) * containerWidth;
          if (pixelWidth >= 250) {
            sidebar.style.width = newSidebarWidth + '%';
            updateTogglePosition();
          }
        }
      }

      function handleMouseUp() {
        isResizing = false;
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
      }
    }

    function initVerticalResizeHandle() {
      const resizeHandle = document.getElementById('verticalResizeHandle');
      const mainPanel = document.getElementById('main');
      const summaryPanel = document.getElementById('summary-panel');
      let isResizing = false;

      resizeHandle.addEventListener('mousedown', function(e) {
        if (!summaryPanel.classList.contains('visible')) return;
        
        isResizing = true;
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        e.preventDefault();
      });

      function handleMouseMove(e) {
        if (!isResizing) return;
        
        const container = document.getElementById('main-container');
        const containerWidth = container.clientWidth;
        const containerLeft = container.getBoundingClientRect().left;
        const mouseX = e.clientX - containerLeft;
        
        const newMainWidth = (mouseX / containerWidth) * 100;
        
        if (newMainWidth >= 20 && newMainWidth <= 80) {
          mainPanel.style.flex = `${newMainWidth} 0 0`;
          summaryPanel.style.width = `${100 - newMainWidth}%`;
          summaryPanel.style.marginRight = '24px';
        }
      }

      function handleMouseUp() {
        isResizing = false;
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
      }
    }
  </script>
<script>
document.addEventListener("DOMContentLoaded", async function () {
  console.log("[INIT] Lade verfügbare GA-Bände...");
  const gaFilter = document.getElementById("gaFilter");
  const thematicGAFilter = document.getElementById("thematicGAFilter");

  if (!gaFilter || !thematicGAFilter) {
    console.error("[FEHLER] Dropdown-Elemente nicht gefunden!");
    return;
  }

  gaFilter.innerHTML = '<option value="">alle GA-Bände</option>';
  thematicGAFilter.innerHTML = '<option value="">alle GA-Bände</option>';

  try {
    const response = await fetch("http://localhost:3003/api/available-ga");
    if (!response.ok) throw new Error("API-Fehler");

    const data = await response.json();
    const availableGAs = new Set(data.availableGA.map(e => e.toUpperCase()));
    console.log("[INFO] Verfügbare GA-Bände:", availableGAs);

    for (let i = 1; i <= 400; i++) {
      const gaNumber = "GA" + String(i).padStart(3, "0");
      const isAvailable = availableGAs.has(gaNumber);

      const opt1 = document.createElement("option");
      opt1.value = gaNumber;
      opt1.textContent = gaNumber;
      if (!isAvailable) {
        opt1.disabled = true;
        opt1.style.color = "gray";
      } else {
        opt1.classList.add("available-ga");
      }

      const opt2 = opt1.cloneNode(true);
      gaFilter.appendChild(opt1);
      thematicGAFilter.appendChild(opt2);
    }
  } catch (err) {
    console.error("[FEHLER] GA-Liste konnte nicht geladen werden:", err);
  }
});
</script>
</body>
</html>