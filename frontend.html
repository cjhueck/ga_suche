<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>GA Steiner Suche - Unified</title>
  <style>
    html, body { scroll-behavior: auto; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, Ubuntu, sans-serif;
      height: 100vh;
      display: flex;
    }
    #sidebar {
      width: 35%;
      min-width: 250px;
      max-width: none;
      overflow: auto;
      border-right: 1px solid #ddd;
      padding: 1rem;
      box-sizing: border-box;
    }
    
    .resize-handle {
      width: 5px;
      background-color: #f5f5f5;
      cursor: col-resize;
      position: relative;
      flex-shrink: 0;
      transition: background-color 0.2s;
    }
    
    .resize-handle:hover {
      background-color: #e0e0e0;
    }
    
    #main-container {
      flex: 1;
      display: flex;
      flex-direction: row;
      min-width: 0;
      overflow: hidden;
    }
    
    #main {
      flex: 1;
      overflow-y: auto;
      padding: 2rem;
      min-width: 0;
      line-height: 1.45;
      position: relative;
    }
    
    #viewer-controls {
      position: fixed;
      right: -192px;
      bottom: 100px;
      background: #467886;
      border: 1px solid #467886;
      border-right: none;
      border-radius: 8px 0 0 8px;
      box-shadow: -2px 0 8px rgba(0,0,0,0.2);
      transition: right 0.3s ease;
      z-index: 100;
    }
    
    #viewer-controls.expanded {
      right: 0;
    }
    
    .controls-toggle {
      position: absolute;
      left: -32px;
      top: 50%;
      transform: translateY(-50%);
      width: 32px;
      height: 80px;
      background: #467886;
      border: 1px solid #467886;
      border-right: none;
      border-radius: 8px 0 0 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: white;
      transition: background 0.2s;
      box-shadow: -2px 0 4px rgba(0,0,0,0.15);
    }
    
    .controls-toggle:hover {
      background: #355d68;
    }
    
    .controls-content {
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: 160px;
    }
    
    .controls-content .search-button {
      margin: 0;
      width: 100%;
      text-align: center;
      white-space: nowrap;
      font-size: 0.9em;
      background: white;
      color: #467886;
    }
    
    .controls-content .search-button:hover {
      background: #f5f5f5;
    }
    
    .controls-content .search-button:disabled {
      background: #f5f5f5;
      color: #999;
      opacity: 1;
      cursor: not-allowed;
    }
    
    #main p {
      margin: 0.8em 0;
    }
    
    #summary-panel {
      display: none;
      flex-direction: column;
      border-left: 1px solid #ddd;
      overflow: hidden;
      width: 25%;
      min-width: 200px;
      max-width: 350px;
      background: #fafafa;
    }
    
    #summary-panel.visible {
      display: flex;
    }
    
    .vertical-resize-handle {
      width: 5px;
      background-color: #f5f5f5;
      cursor: col-resize;
      position: relative;
      flex-shrink: 0;
      transition: background-color 0.2s;
      display: none;
    }
    
    .vertical-resize-handle.visible {
      display: block;
    }
    
    .vertical-resize-handle:hover {
      background-color: #e0e0e0;
    }
    
    #summary-content {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      line-height: 1.5;
      font-size: 0.95em;
    }
    
    #summary-content h3 {
      font-size: 1em;
      margin: 0.8em 0 0.3em 0;
      font-weight: 600;
      color: #467886;
      cursor: pointer;
      transition: color 0.2s;
    }
    
    #summary-content h3:hover {
      color: #355d68;
    }
    
    #summary-content .toc-item {
      padding: 0.4em 0;
      border-bottom: 1px solid #e0e0e0;
    }
    
    #summary-content .toc-item:last-child {
      border-bottom: none;
    }
    
    h1 { margin-bottom: 0.5rem; margin-top: 0; }
    #document-title { margin-top: 0; margin-bottom: 1rem; }
    #document-title a { color: #467886; text-decoration: none; }
    #document-title a:hover { text-decoration: underline; }
    
    #summary-title { margin-top: 0; margin-bottom: 1rem; }
    #summary-title a { color: #467886; text-decoration: none; }
    #summary-title a:hover { text-decoration: underline; }
    
    .close-button {
      background: none;
      border: none;
      font-size: 28px;
      line-height: 1;
      color: #999;
      cursor: pointer;
      padding: 4px 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s;
      flex-shrink: 0;
      margin-left: 15px;
    }
    
    .close-button:hover {
      background: #f0f0f0;
      color: #467886;
    }
    
    .tab-container {
      margin-bottom: 1rem;
    }
    
    .tab-buttons {
      display: flex;
      border-bottom: 2px solid #eee;
      margin-bottom: 1rem;
    }
    
    .tab-button {
      padding: 8px 16px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      color: #666;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    
    .tab-button.active {
      color: #467886;
      border-bottom-color: #467886;
    }
    
    .tab-button:hover {
      color: #467886;
      opacity: 0.7;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .thematic-input {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      box-sizing: border-box;
      border: 1px solid #467886;
      background: white;
      font-size: 16px;
      min-height: 80px;
      resize: vertical;
      border-radius: 4px;
    }
    
    .semantic-options {
      margin: 10px 0;
    }
    
    .semantic-options h4 {
      margin: 0 0 8px 0;
      color: #467886;
    }
    
    .depth-buttons {
      display: flex;
      gap: 8px;
      margin: 8px 0;
    }
    
    .depth-btn {
      padding: 6px 12px;
      border: 1px solid #467886;
      background: white;
      color: #467886;
      cursor: pointer;
      border-radius: 4px;
      font-size: 0.9em;
      transition: all 0.2s;
    }
    
    .depth-btn.active {
      background: white;
      color: #467886;
      border: 2px solid #467886;
    }
    
    .depth-btn.primary {
      background: #467886;
      color: white;
      border: 2px solid #467886;
    }
    
    .depth-btn.primary:hover {
      background: #355d68;
      border-color: #355d68;
    }
    
    .depth-btn:hover {
      opacity: 0.8;
    }
    
    .depth-btn:disabled {
      cursor: not-allowed;
      background: #f5f5f5;
      opacity: 0.6;
    }
    
    .depth-btn.primary:disabled {
      background: #ccc;
      border-color: #ccc;
      cursor: not-allowed;
      color: #467886;
    }
    
    .depth-btn.processing {
      font-style: italic;
    }
    
    .ga-reference {
      color: #467886;
      text-decoration: none;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 3px;
      background: rgba(70, 120, 134, 0.1);
      transition: all 0.2s ease;
      cursor: pointer;
      border: 1px solid transparent;
    }
    
    .ga-reference:hover {
      background: rgba(70, 120, 134, 0.2);
      border-color: #467886;
      text-decoration: none;
    }
    
    .highlighted-paragraph {
      background: rgba(70, 120, 134, 0.1);
      padding: 0.5rem;
      border-radius: 4px;
      margin: 0.2rem 0;
    }
    
    .semantic-answer {
      background: #f0f8ff;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
    }
    
    .semantic-answer h3 {
      display: none;
    }
    
    .answer-content {
      line-height: 1.6;
    }
    
    .answer-content h1 {
      display: none;
    }
    
    .answer-content h2 {
      font-size: 1.1em;
      margin: 0.4em 0 0.2em 0;
      font-weight: 600;
    }
    
    .answer-content h3 {
      font-size: 1em;
      margin: 0.3em 0 0.2em 0;
      font-weight: 600;
      display: block;
    }
    
    .answer-content p {
      margin: 0.3em 0;
      font-weight: normal;
    }
    
    .answer-content strong {
      font-weight: 600;
    }
    
    .answer-content ul, .answer-content ol {
      margin: 0.3em 0;
      padding-left: 1.5em;
    }
    
    .loading {
      color: #467886;
      font-style: italic;
    }
    
    .error-message {
      background: #fff5f5;
      border-left: 4px solid #e53e3e;
      padding: 10px;
      margin: 10px 0;
      color: #c53030;
      border-radius: 0 4px 4px 0;
    }
    
    .search-input {
      width: 100%;
      padding: 8px;
      margin: 4px 0;
      box-sizing: border-box;
      border: 1px solid #ccc;
      background: white;
      font-size: 1em;
    }
    
    .filter-row {
      display: flex;
      gap: 10px;
      margin-top: 6px;
    }
    
    .filter-dropdown {
      flex: 1;
      height: 2.2em;
      padding: 8px;
      margin: 4px 0;
      font-size: 0.95em;
      box-sizing: border-box;
      border: 1px solid #ccc;
      background: white;
    }
    
    .filter-dropdown:disabled {
      background: #f5f5f5;
      color: #999;
      cursor: not-allowed;
    }
    
    .radio-group {
      margin: 6px 0;
      display: flex;
      gap: 12px;
    }
    
    .radio-group label {
      cursor: pointer;
    }
    
    .radio-group input[type="radio"]:checked + span {
      color: #467886;
      font-weight: 600;
    }
    
    .search-button {
      padding: 6px 12px;
      border-radius: 4px;
      border: 2px solid #467886;
      background: white;
      color: #467886;
      cursor: pointer;
      font-size: 0.9em;
      margin-bottom: 0.4rem;
    }
    
    .search-button:hover { opacity: .85; }
    .search-button:disabled {
      cursor: not-allowed;
      background: #f5f5f5;
      color: #999;
      opacity: 1;
    }
    
    .search-button.processing {
      font-style: italic;
    }
    
    #status { margin-left: 0.5em; color: #666; }
    #note { margin-top: 0.5rem; font-size: 0.9em; color: #666; }
    
    ul.results-list { 
      list-style-type: disc; 
      padding-left: 1.2em; 
      margin: 0;
      padding-top: 0.3rem;
    }
    ul.results-list > li > a { font-weight: bold; color: #467886; }
    ul.sub-headings { list-style-type: none; padding-left: 1.5em; margin: 0.25em 0; }
    ul.sub-headings li::before { content: "– "; color: #333; }
    a { color: #467886; text-decoration: none; cursor: pointer; }
    a:hover { text-decoration: underline; }
    .snippet { font-size: 0.9em; color: #444; margin: 4px 0; cursor: pointer; }
    mark { 
      background: rgba(70, 120, 134, 0.2); 
      color: inherit;
    }
    
    .paragraph { 
      margin: 0.8em 0;
      line-height: 1.45;
    }
    
    #viewer {
      line-height: 1.45;
    }
    
    #viewer .paragraph {
      margin-bottom: 0.8em;
    }
    
    #viewer p {
      margin: 0.8em 0;
      line-height: 1.45;
    }
    
    #viewer .highlighted-paragraph {
      background: rgba(70, 120, 134, 0.1);
      padding: 0.5rem;
      border-radius: 4px;
      margin: 0.2rem 0;
    }
    
    #summary-content p strong {
      font-size: 1.0em;
      font-weight: 700;
      color: #467886;
      display: block;
      margin: 1.0em 0 0.5em 0;
      font-style: normal;
    }
    
    #summary-content > p:first-of-type strong {
      margin-top: 0;
    }
    
    #summary-content > p:first-of-type {
      margin-bottom: 1rem;
    }
    
    #summary-content > p:first-of-type:not(:has(strong:only-child)) {
      font-style: italic;
    }
    
    #summary-content .paragraph {
      margin-bottom: 0.8em;
    }
    
    #summary-content h1,
    #summary-content h2,
    #summary-content h3 {
      font-size: 1.0em;
      margin: 1.0em 0 0.5em 0;
      font-weight: 700;
      color: #467886;
      display: block;
    }
    
    #summary-content h1:first-child,
    #summary-content h2:first-child,
    #summary-content h3:first-child {
      margin-top: 0;
    }
    
    #viewer p strong {
      font-size: 1.0em;
      font-weight: 700;
      color: #467886;
      display: block;
      margin: 1.0em 0 0.5em 0;
      font-style: normal;
    }
    
    #viewer > p:first-of-type strong {
      margin-top: 0;
    }
    
    #viewer h1,
    #viewer h2,
    #viewer h3 {
      font-size: 1.0em;
      margin: 1.0em 0 0.5em 0;
      font-weight: 700;
      color: #467886;
      display: block;
    }
    
    #viewer h1:first-child,
    #viewer h2:first-child,
    #viewer h3:first-child {
      margin-top: 0;
    }
    
    #viewer > p:first-of-type {
      font-style: italic;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h1>GA Steiner Suche</h1>
    
    <div class="tab-container">
      <div class="tab-buttons">
        <button class="tab-button active" onclick="switchTab('keyword')">Stichwort-Suche</button>
        <button class="tab-button" onclick="switchTab('thematic')">Themen-Suche</button>
      </div>
      
      <div id="keyword-tab" class="tab-content active">
        <div style="display:flex; gap:8px; margin-top:4px;">
          <div style="flex:1; position: relative;">
            <input class="search-input" id="word1" type="text" placeholder="Suchwort 1" list="word1-history" onkeypress="handleKeywordKeypress(event)" oninput="updateProximityFilter()" onfocus="this.select()">
            <datalist id="word1-history"></datalist>
          </div>
          <div style="flex:1; position: relative;">
            <input class="search-input" id="word2" type="text" placeholder="Suchwort 2 (optional)" list="word2-history" oninput="updateProximityFilter()" onfocus="this.select()">
            <datalist id="word2-history"></datalist>
          </div>
        </div>
        
        <div class="filter-row">
          <select id="yearFilter" class="filter-dropdown">
            <option value="">Alle Jahre</option>
          </select>
          
          <select id="gaFilter" class="filter-dropdown">
            <option value="">Alle GA-Bände</option>
          </select>
          
          <select id="proximityFilter" class="filter-dropdown" disabled>
            <option value="">keine Beschränkung</option>
            <option value="1">ein Absatz</option>
            <option value="2">zwei Absätze</option>
            <option value="3">drei Absätze</option>
          </select>
        </div>
        
        <div class="radio-group">
          <label><input type="radio" name="scope" value="fulltext" checked><span> Volltext</span></label>
          <label><input type="radio" name="scope" value="title"><span> Titel</span></label>
          <button class="depth-btn primary" onclick="performKeywordSearch()" style="margin-left: auto; margin-bottom: 0;">Suche starten</button>
        </div>
        
        <div id="searchInfo" style="font-size: 0.9em; color: #666; margin-top: 0.5rem; margin-bottom: 0.3rem; padding-bottom: 0.5rem; border-bottom: 1px solid #ddd;">
          <span id="serverInfo"></span>
          <span id="resultInfo"></span>
        </div>
      </div>
      
      <div id="thematic-tab" class="tab-content">
        <textarea class="thematic-input" id="thematicQuery" 
                  placeholder="Stellen Sie eine thematische Frage, z.B.:&#10;&#10;• Wie sieht Steiner das Verhältnis von Kant zu Goethe?&#10;• Was kritisiert Steiner an Kants Erkenntnistheorie?&#10;• Welche Rolle spielt die Anschauung bei Kant?"
                  onkeydown="handleThematicKeydown(event)"></textarea>
        
        <div class="semantic-options">
          <div class="filter-row">
            <select id="thematicLimitFilter" class="filter-dropdown">
              <option value="30">30 Quellen</option>
              <option value="50">50 Quellen</option>
              <option value="100">100 Quellen</option>
            </select>
            <select id="thematicGAFilter" class="filter-dropdown">
              <option value="">Alle GA-Bände</option>
              <option value="GA052">GA052</option>
              <option value="GA058">GA058</option>
            </select>
          </div>
          
          <div class="depth-buttons">
            <button class="depth-btn active" data-depth="allgemein">Allgemein</button>
            <button class="depth-btn" data-depth="ausführlich">Ausführlich</button>
            <button class="depth-btn primary" onclick="performThematicSearch()" id="thematicSearchBtn" 
                    style="margin-left: auto;">
              Suche starten
            </button>
          </div>
        </div>
        
        <div id="thematicSearchInfo" style="font-size: 0.9em; color: #666; margin-top: 0.5rem; margin-bottom: 0.3rem; padding-bottom: 0.5rem; border-bottom: 1px solid #ddd;">
          <span id="thematicServerInfo"></span>
        </div>
      </div>
    </div>
    
    <span id="status"></span>
    <div id="note" style="display: none;"></div>
    <div id="results"></div>
  </div>

  <div class="resize-handle" id="resizeHandle"></div>

  <div id="main-container">
    <div id="main">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 id="document-title" style="margin: 0; flex: 1;">Bitte ein Ergebnis auswählen…</h2>
      </div>
      <div id="viewer"></div>
      
      <!-- Viewer Controls Sidebar -->
      <div id="viewer-controls">
        <div class="controls-toggle" onclick="toggleViewerControls()">
          <span id="controls-toggle-icon">◄</span>
        </div>
        <div class="controls-content">
          <button class="search-button" onclick="showSummaryAction()" id="summaryActionBtn" disabled>
            Zusammenfassen
          </button>
          <button class="search-button" id="tocActionBtn" onclick="toggleTOC()" disabled>
            Inhaltsverzeichnis
          </button>
          <button class="search-button" onclick="showOriginalAction()" id="originalActionBtn" style="display: none;">
            Original anzeigen
          </button>
        </div>
      </div>
    </div>
    
    <div class="vertical-resize-handle" id="verticalResizeHandle"></div>
    
    <div id="summary-panel">
      <div id="summary-content">
        <div id="toc-list"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    const API_BASE = 'http://localhost:3003';
    let currentSources = [];
    let searchResults = [];
    let currentLectureData = null;
    let currentThematicQuery = '';
    let searchHistory = {
      word1: [],
      word2: []
    };
    let showingSummaryInMain = false;
    let currentLectureSummary = null;
    let lastHighlightedIndex = null;

    function addToHistory(field, value) {
      if (!value || !value.trim()) return;
      
      const trimmed = value.trim();
      
      searchHistory[field] = searchHistory[field].filter(item => item !== trimmed);
      searchHistory[field].unshift(trimmed);
      searchHistory[field] = searchHistory[field].slice(0, 10);
      
      updateHistoryDatalist();
    }

    function updateHistoryDatalist() {
      const word1List = document.getElementById('word1-history');
      const word2List = document.getElementById('word2-history');
      
      if (word1List) {
        word1List.innerHTML = searchHistory.word1.map(item => 
          `<option value="${item}">`
        ).join('');
      }
      
      if (word2List) {
        word2List.innerHTML = searchHistory.word2.map(item => 
          `<option value="${item}">`
        ).join('');
      }
    }

    function switchTab(mode) {
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`[onclick="switchTab('${mode}')"]`).classList.add('active');
      
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(`${mode}-tab`).classList.add('active');
    }

    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.depth-btn[data-depth]').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.depth-btn[data-depth]').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
        });
      });
      
      populateYearFilter();
      populateGAFilters();
      initResizeHandle();
      initVerticalResizeHandle();
      checkServerConnection();
    });

    function populateYearFilter() {
      const yearFilter = document.getElementById('yearFilter');
      
      for (let year = 1882; year <= 1925; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearFilter.appendChild(option);
      }
    }

    function populateGAFilters() {
      const gaFilter = document.getElementById('gaFilter');
      const thematicGAFilter = document.getElementById('thematicGAFilter');
      
      gaFilter.innerHTML = '<option value="">Alle GA-Bände</option>';
      thematicGAFilter.innerHTML = '<option value="">Alle GA-Bände</option>';
      
      for (let num = 1; num <= 400; num++) {
        const gaNumber = 'GA' + String(num).padStart(3, '0');
        
        const option1 = document.createElement('option');
        option1.value = gaNumber;
        option1.textContent = gaNumber;
        gaFilter.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = gaNumber;
        option2.textContent = gaNumber;
        thematicGAFilter.appendChild(option2);
      }
    }

    async function checkServerConnection() {
      try {
        const response = await fetch(`${API_BASE}/debug/status`);
        if (response.ok) {
          const data = await response.json();
          const infoText = `${data.lecturesLoaded} Vorträge verfügbar`;
          document.getElementById('serverInfo').textContent = infoText;
          document.getElementById('thematicServerInfo').textContent = infoText;
        }
      } catch (error) {
        const errorText = `<span style="color: #c53030;">Server nicht erreichbar</span>`;
        document.getElementById('serverInfo').innerHTML = errorText;
        document.getElementById('thematicServerInfo').innerHTML = errorText;
      }
    }

    function updateProximityFilter() {
      const word1 = document.getElementById('word1').value.trim();
      const word2 = document.getElementById('word2').value.trim();
      const proximityFilter = document.getElementById('proximityFilter');
      
      if (word1 && word2) {
        proximityFilter.disabled = false;
      } else {
        proximityFilter.disabled = true;
        proximityFilter.selectedIndex = 0;
      }
    }

    async function performKeywordSearch() {
      const word1Input = document.getElementById('word1').value.trim();
      const word2Input = document.getElementById('word2').value.trim();
      
      if (!word1Input && !word2Input) {
        alert('Bitte mindestens ein Suchwort eingeben');
        return;
      }
      
      document.getElementById('viewer').innerHTML = '';
      document.getElementById('document-title').textContent = 'Bitte ein Ergebnis auswählen…';
      
      if (word1Input) addToHistory('word1', word1Input);
      if (word2Input) addToHistory('word2', word2Input);
      
      const word1 = word1Input || word2Input;
      const word2 = word1Input && word2Input ? word2Input : null;
      
      const button = document.querySelector('#keyword-tab .depth-btn.primary');
      
      try {
        button.disabled = true;
        button.classList.add('processing');
        button.textContent = 'Suche läuft...';
        document.getElementById('status').innerHTML = '<span class="loading">Suche läuft...</span>';
        
        const gaFilter = document.getElementById('gaFilter').value;
        const proximityFilter = document.getElementById('proximityFilter').value;
        
        const response = await fetch(`${API_BASE}/api/fulltext-search`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            word1: word1,
            word2: word2,
            proximity: proximityFilter || null
          })
        });
        
        if (!response.ok) throw new Error(`Server Error: ${response.status}`);
        
        const data = await response.json();
        let results = data.results;
        
        console.log(`Volltext-Suche: ${results.length} Absätze gefunden`);
        
        if (gaFilter) {
          results = results.filter(r => r.ID && r.ID.startsWith(gaFilter));
        }
        
        searchResults = results;
        const displayQuery = word1Input && word2Input ? `${word1Input} + ${word2Input}` : (word1Input || word2Input);
        renderKeywordResults(displayQuery, results, word1Input, word2Input);
        
        document.getElementById('resultInfo').textContent = ` • ${results.length} Treffer`;
        
      } catch (error) {
        console.error('Keyword-Suche Fehler:', error);
        document.getElementById('results').innerHTML = `
          <div class="error-message">
            <strong>Fehler bei der Suche:</strong><br>${error.message}
          </div>
        `;
      } finally {
        button.disabled = false;
        button.classList.remove('processing');
        button.textContent = 'Suche starten';
        document.getElementById('status').textContent = '';
      }
    }

    function extractDateFromFileName(fileName) {
      if (!fileName) return '';
      
      const monthNames = {
        'januar': '01', 'februar': '02', 'märz': '03', 'april': '04',
        'mai': '05', 'juni': '06', 'juli': '07', 'august': '08',
        'september': '09', 'oktober': '10', 'november': '11', 'dezember': '12'
      };
      
      let dateMatch = fileName.match(/(\d{1,2})\.\s+([a-zä]+)\s+(\d{4})/i);
      
      if (dateMatch) {
        const day = dateMatch[1].padStart(2, '0');
        const monthName = dateMatch[2].toLowerCase();
        const year = dateMatch[3];
        const month = monthNames[monthName] || '00';
        
        return `${year}-${month}-${day}`;
      }
      
      dateMatch = fileName.match(/im\s+([a-zä]+)\s+(\d{4})/i);
      if (dateMatch) {
        const monthName = dateMatch[1].toLowerCase();
        const year = dateMatch[2];
        const month = monthNames[monthName] || '00';
        
        return `${year}-${month}-01`;
      }
      
      dateMatch = fileName.match(/(\d{4})/);
      if (dateMatch) {
        return `${dateMatch[1]}-00-00`;
      }
      
      return '';
    }

    function renderKeywordResults(query, results, word1, word2) {
      const container = document.getElementById('results');
      const scope = document.querySelector('input[name="scope"]:checked').value;
      
      if (results.length === 0) {
        container.innerHTML = '<p><em>Keine Treffer gefunden.</em></p>';
        return;
      }
      
      const list = document.createElement('ul');
      list.className = 'results-list';
      list.style.marginTop = '0';
      list.style.paddingTop = '0.5rem';
      
      const groupedByLecture = {};
      results.forEach(result => {
        const lectureId = result.ID;
        if (!groupedByLecture[lectureId]) {
          let lectureDate = result.date || '';
          if (!lectureDate && result.fileName) {
            lectureDate = extractDateFromFileName(result.fileName);
          }
          
          groupedByLecture[lectureId] = {
            fileName: result.fileName || result.title,
            date: lectureDate,
            chunks: []
          };
        }
        groupedByLecture[lectureId].chunks.push(result);
      });
      
      const sortedLectures = Object.entries(groupedByLecture).sort((a, b) => {
        const dateA = a[1].date || '';
        const dateB = b[1].date || '';
        return dateA.localeCompare(dateB);
      });
      
      sortedLectures.forEach(([lectureId, lecture]) => {
        const li = document.createElement('li');
        
        const titleLink = document.createElement('a');
        titleLink.href = "#";
        titleLink.textContent = lecture.fileName;
        titleLink.addEventListener('click', (e) => {
          e.preventDefault();
          showLectureTop(lectureId);
        });
        
        li.appendChild(titleLink);
        
        if (scope === "fulltext") {
          const proximityFilter = document.getElementById('proximityFilter').value;
          
          let lectureChunks = lecture.chunks;
          
          if (word1 && word2 && proximityFilter && proximityFilter !== '') {
            lectureChunks = lecture.chunks.filter(chunk => {
              const contentLower = (chunk.content || '').toLowerCase();
              return contentLower.includes(word1.toLowerCase()) && 
                     contentLower.includes(word2.toLowerCase());
            });
          }
          
          lectureChunks.slice(0, 5).forEach(chunk => {
            const snippetDiv = document.createElement("div");
            snippetDiv.className = "snippet";
            
            const content = chunk.content || '';
            
            let snippet = '';
            let foundPosition = -1;
            let foundWord = null;
            
            const contentLower = content.toLowerCase();
            const positions = [];
            
            if (word1 && word1.trim()) {
              const pos = contentLower.indexOf(word1.toLowerCase());
              if (pos !== -1) positions.push({ pos, word: word1 });
            }
            
            if (word2 && word2.trim()) {
              const pos = contentLower.indexOf(word2.toLowerCase());
              if (pos !== -1) positions.push({ pos, word: word2 });
            }
            
            if (positions.length > 0) {
              positions.sort((a, b) => a.pos - b.pos);
              foundPosition = positions[0].pos;
              foundWord = positions[0].word;
            }
            
            if (foundPosition !== -1 && content) {
              const start = Math.max(0, foundPosition - 200);
              const end = Math.min(content.length, foundPosition + foundWord.length + 200);
              
              snippet = (start > 0 ? '...' : '') + 
                        content.substring(start, end) + 
                        (end < content.length ? '...' : '');
              
              if (word1 && word1.trim()) {
                const regex = new RegExp(`(${word1.trim()})`, "gi");
                snippet = snippet.replace(regex, "<mark>$1</mark>");
              }
              
              if (word2 && word2.trim()) {
                const regex = new RegExp(`(${word2.trim()})`, "gi");
                snippet = snippet.replace(regex, "<mark>$1</mark>");
              }
              
              snippetDiv.innerHTML = snippet;
              snippetDiv.style.cursor = 'pointer';
              snippetDiv.setAttribute('data-lecture-id', lectureId);
              snippetDiv.setAttribute('data-chunk-index', chunk.index);
              snippetDiv.addEventListener("click", function(e) {
                e.preventDefault();
                e.stopPropagation();
                const currentWord1 = document.getElementById('word1').value.trim();
                const currentWord2 = document.getElementById('word2').value.trim();
                const keywords = [currentWord1, currentWord2].filter(w => w && w.trim());
                const lecId = e.currentTarget.getAttribute('data-lecture-id');
                const chunkIdx = e.currentTarget.getAttribute('data-chunk-index');
                
                showingSummaryInMain = false;
                const toggleBtn = document.getElementById('toggleViewBtn');
                if (toggleBtn) {
                  toggleBtn.textContent = 'Zusammenfassung zeigen';
                }
                
                showLecture(lecId, chunkIdx, keywords);
              });
              li.appendChild(snippetDiv);
            }
          });
        }
        
        list.appendChild(li);
      });
      
      container.innerHTML = '';
      container.appendChild(list);
      
      const lectureCount = sortedLectures.length;
      const chunkCount = results.length;
      document.getElementById('status').textContent = `${lectureCount} Vorträge mit ${chunkCount} Treffern`;
    }

    async function performThematicSearch() {
      const query = document.getElementById('thematicQuery').value.trim();
      if (!query) return;
      
      currentThematicQuery = query;
      
      const button = document.getElementById('thematicSearchBtn');
      const originalText = button.textContent;
      
      try {
        button.disabled = true;
        button.classList.add('processing');
        button.textContent = 'Suche läuft...';
        
        const depth = document.querySelector('.depth-btn.active').dataset.depth;
        const limit = document.getElementById('thematicLimitFilter').value;
        const gaFilter = document.getElementById('thematicGAFilter').value;
        
        const response = await fetch(`${API_BASE}/api/thematic-hybrid-search`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query: query,
            depth: depth,
            limit: parseInt(limit)
          })
        });
        
        if (!response.ok) throw new Error(`Server Error: ${response.status}`);
        
        const answer = await response.json();
        let sources = answer.sources || [];
        
        if (gaFilter) {
          sources = sources.filter(source => source.ID && source.ID.startsWith(gaFilter));
        }
        
        currentSources = sources;
        renderThematicResults(query, answer.content, sources);
        
      } catch (error) {
        console.error('Thematic Search Error:', error);
        document.getElementById('results').innerHTML = `
          <div class="error-message">
            <strong>Fehler bei der Themen-Suche:</strong><br>${error.message}
          </div>
        `;
      } finally {
        button.disabled = false;
        button.classList.remove('processing');
        button.textContent = 'Suche starten';
        document.getElementById('status').textContent = '';
      }
    }

    function updateButtonStates() {
      const summaryActionBtn = document.getElementById('summaryActionBtn');
      const originalActionBtn = document.getElementById('originalActionBtn');
      const tocActionBtn = document.getElementById('tocActionBtn');
      
      if (summaryActionBtn && currentLectureData) {
        summaryActionBtn.disabled = false;
        
        if (currentLectureSummary && showingSummaryInMain) {
          summaryActionBtn.textContent = 'Zusammenfassung';
          summaryActionBtn.style.fontStyle = 'normal';
        } else if (currentLectureSummary) {
          summaryActionBtn.textContent = 'Zusammenfassung';
          summaryActionBtn.style.fontStyle = 'normal';
        } else {
          summaryActionBtn.textContent = 'Zusammenfassen';
          summaryActionBtn.style.fontStyle = 'normal';
        }
      }
      
      if (originalActionBtn) {
        if (showingSummaryInMain) {
          originalActionBtn.style.display = 'block';
        } else {
          originalActionBtn.style.display = 'none';
        }
      }
      
      if (tocActionBtn) {
        if (currentLectureSummary && showingSummaryInMain) {
          tocActionBtn.disabled = false;
          tocActionBtn.style.opacity = '1';
        } else {
          tocActionBtn.disabled = true;
          tocActionBtn.style.opacity = '0.5';
        }
      }
    }

    function toggleViewerControls() {
      const controls = document.getElementById('viewer-controls');
      const icon = document.getElementById('controls-toggle-icon');
      
      if (controls.classList.contains('expanded')) {
        controls.classList.remove('expanded');
        icon.textContent = '◄';
      } else {
        controls.classList.add('expanded');
        icon.textContent = '►';
      }
    }

    function getCurrentVisibleParagraphIndex() {
      const mainContainer = document.getElementById('main');
      const allParagraphs = document.querySelectorAll('[id^="para-"]');
      
      if (allParagraphs.length === 0) return null;
      
      const containerTop = mainContainer.getBoundingClientRect().top;
      
      for (let para of allParagraphs) {
        const paraRect = para.getBoundingClientRect();
        const relativeTop = paraRect.top - containerTop;
        
        if (relativeTop >= -50 && relativeTop <= 100) {
          return para.id.replace('para-', '');
        }
      }
      
      return allParagraphs[0].id.replace('para-', '');
    }

    async function showSummaryAction() {
      if (!currentLectureData) return;
      
      const summaryActionBtn = document.getElementById('summaryActionBtn');
      
      if (!currentLectureSummary) {
        try {
          summaryActionBtn.disabled = true;
          summaryActionBtn.style.fontStyle = 'italic';
          summaryActionBtn.textContent = 'bitte warten...';
          
          const response = await fetch(`${API_BASE}/api/summarize-lecture`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              lectureId: currentLectureData.ID,
              forceRegenerate: false
            })
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `Server Error: ${response.status}`);
          }
          
          const data = await response.json();
          
          currentLectureSummary = {
            summary: data.summary,
            headings: data.headings || []
          };
        } catch (error) {
          console.error('Zusammenfassungs-Fehler:', error);
          alert(`Fehler: ${error.message}`);
          summaryActionBtn.disabled = false;
          summaryActionBtn.style.fontStyle = 'normal';
          summaryActionBtn.textContent = 'Zusammenfassen';
          return;
        }
      }
      
      const visibleIndex = getCurrentVisibleParagraphIndex();
      if (visibleIndex) {
        lastHighlightedIndex = visibleIndex;
      }
      
      showingSummaryInMain = true;
      displaySummaryWithHeadings(currentLectureData, currentLectureSummary);
      buildTableOfContents();
      updateButtonStates();
      
      const summaryPanel = document.getElementById('summary-panel');
      const resizeHandle = document.getElementById('verticalResizeHandle');
      
      summaryPanel.classList.add('visible');
      resizeHandle.classList.add('visible');
      
      if (lastHighlightedIndex) {
        scrollToIndexInViewer(lastHighlightedIndex);
      }
    }

    function scrollToIndexInViewer(targetIndex) {
      if (!targetIndex) return;
      
      const mainContainer = document.getElementById('main');
      const paraElement = document.getElementById(`para-${targetIndex}`);
      
      if (paraElement) {
        const mainRect = mainContainer.getBoundingClientRect();
        const paraRect = paraElement.getBoundingClientRect();
        const relativeTop = paraRect.top - mainRect.top + mainContainer.scrollTop;
        mainContainer.scrollTop = relativeTop;
      }
    }

    function scrollToIndexInSummary(targetIndex) {
      if (!targetIndex) return;
      
      const paraElement = document.getElementById(`para-${targetIndex}`);
      if (paraElement) {
        paraElement.scrollIntoView({ behavior: 'auto', block: 'start' });
      }
    }

    function showOriginalAction() {
      if (!currentLectureData) return;
      
      const summaryPanel = document.getElementById('summary-panel');
      if (summaryPanel.classList.contains('visible')) {
        summaryPanel.classList.remove('visible');
        document.getElementById('verticalResizeHandle').classList.remove('visible');
      }
      
      const visibleIndex = getCurrentVisibleParagraphIndex();
      if (visibleIndex) {
        lastHighlightedIndex = visibleIndex;
      }
      
      showingSummaryInMain = false;
      
      const currentWord1 = document.getElementById('word1').value.trim();
      const currentWord2 = document.getElementById('word2').value.trim();
      let keywords = [currentWord1, currentWord2].filter(w => w && w.trim());
      if (keywords.length === 0 && currentThematicQuery) {
        keywords = extractKeywordsFromQuery(currentThematicQuery);
      }
      
      displayLecture(currentLectureData, lastHighlightedIndex, keywords, false);
      
      if (lastHighlightedIndex) {
        scrollToIndexInViewer(lastHighlightedIndex);
      }
      
      updateButtonStates();
    }

    async function summarizeLecture(event) {
      if (!currentLectureData) {
        alert('Bitte zuerst einen Vortrag im Viewer laden');
        return;
      }
      
      const isKeywordTab = document.getElementById('keyword-tab').classList.contains('active');
      const button = isKeywordTab ? document.getElementById('summarizeBtnKeyword') : document.getElementById('summarizeBtn');
      const originalText = 'Zusammenfassung';
      
      try {
        button.disabled = true;
        button.classList.add('processing');
        button.textContent = 'bitte warten...';
        
        const response = await fetch(`${API_BASE}/api/summarize-lecture`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            lectureId: currentLectureData.ID,
            forceRegenerate: false
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `Server Error: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.fromCache) {
          console.log('Zusammenfassung aus Cache geladen');
        } else {
          console.log('Neue Zusammenfassung generiert und gespeichert');
        }
        
        currentLectureSummary = {
          summary: data.summary,
          headings: data.headings || []
        };
        
        console.log('Geladene Zusammenfassung:', currentLectureSummary);
        console.log('Anzahl Überschriften:', currentLectureSummary.headings.length);
        
        showingSummaryInMain = true;
        
        updateButtonStates();
        
        displaySummaryWithHeadings(currentLectureData, currentLectureSummary);
        buildTableOfContents();
        
      } catch (error) {
        console.error('Zusammenfassungs-Fehler:', error);
        const viewer = document.getElementById('viewer');
        viewer.innerHTML = `
          <div class="error-message">
            <strong>Fehler bei der Zusammenfassung:</strong><br>${error.message}
          </div>
        `;
      } finally {
        button.disabled = !currentLectureData;
        button.classList.remove('processing');
        button.textContent = originalText;
      }
    }

    function displaySummaryWithHeadings(lecture, summaryObj) {
      const viewer = document.getElementById('viewer');
      
      // Nur Keywords highlighten, wenn sie zur aktuellen Suche gehören
      const currentWord1 = document.getElementById('word1').value.trim();
      const currentWord2 = document.getElementById('word2').value.trim();
      let keywords = [];
      
      // Prüfe ob die aktuellen Suchfelder gefüllt sind UND der aktuelle Vortrag aus dieser Suche stammt
      if ((currentWord1 || currentWord2) && searchResults.length > 0) {
        // Prüfe ob der aktuelle Vortrag in den Suchergebnissen ist
        const isFromCurrentSearch = searchResults.some(result => result.ID === lecture.ID);
        if (isFromCurrentSearch) {
          keywords = [currentWord1, currentWord2].filter(w => w && w.trim());
        }
      }
      
      console.log('displaySummaryWithHeadings:', summaryObj);
      
      let html = '';
      
      html += '<div style="margin-bottom: 2rem;">';
      html += '<p><strong>Zusammenfassung</strong></p>';
      html += `<p style="font-style: italic;">${summaryObj.summary}</p>`;
      html += '<hr style="margin: 2rem 0; border: none; border-top: 1px solid #ddd;">';
      html += '</div>';
      
      const headings = summaryObj.headings || [];
      const paragraphs = lecture.paragraphs || [];
      
      console.log('Anzahl Überschriften:', headings.length);
      console.log('Überschriften:', headings);
      console.log('Anzahl Absätze:', paragraphs.length);
      console.log('Erste 3 Absätze (Index-Check):');
      paragraphs.slice(0, 3).forEach((para, idx) => {
        const preview = (para.content || para.text || '').substring(0, 100);
        console.log(`  Absatz ${idx}: "${preview}..."`);
      });
      console.log('Letzte 3 Absätze:');
      paragraphs.slice(-3).forEach((para, idx) => {
        const actualIdx = paragraphs.length - 3 + idx;
        const preview = (para.content || para.text || '').substring(0, 100);
        console.log(`  Absatz ${actualIdx}: "${preview}..."`);
      });
      
      paragraphs.forEach((para, idx) => {
        const paraIndex = para.index ? para.index.replace(/^\^/, '') : `para_${idx}`;
        const heading = headings.find(h => h.index === paraIndex || h.index === para.index);
        if (heading) {
          const headingText = heading.text || heading.title || 'Überschrift';
          console.log(`Füge Überschrift VOR Absatz mit Index ${paraIndex} (Array-Position ${idx}) ein:`, headingText);
          html += `<h3 id="heading-${idx}" style="color: #467886; font-weight: 700; margin: 1.5em 0 0.5em 0;">${headingText}</h3>`;
        }
        
        let content = para.content || para.text || '';
        
        if (keywords && keywords.length > 0) {
          keywords.forEach(word => {
            if (word && word.trim()) {
              const regex = new RegExp(`(${word.trim()})`, "gi");
              content = content.replace(regex, "<mark>$1</mark>");
            }
          });
        }
        
        html += `<div class="paragraph" id="para-${paraIndex}" data-array-index="${idx}">${content}</div>`;
      });
      
      viewer.innerHTML = html;
    }

    async function regenerateSummary() {
      if (!currentLectureData || !showingSummaryInMain) {
        return;
      }
      
      const confirm = window.confirm('Zusammenfassung neu generieren? Dies kann einige Minuten dauern.');
      if (!confirm) return;
      
      const buttonKeyword = document.getElementById('regenerateBtnKeyword');
      const buttonViewer = document.getElementById('regenerateBtnViewer');
      const originalText = 'Neu zusammenfassen';
      
      try {
        if (buttonKeyword) {
          buttonKeyword.disabled = true;
          buttonKeyword.classList.add('processing');
          buttonKeyword.textContent = 'bitte warten...';
        }
        if (buttonViewer) {
          buttonViewer.disabled = true;
          buttonViewer.classList.add('processing');
          buttonViewer.textContent = 'bitte warten...';
        }
        
        const response = await fetch(`${API_BASE}/api/summarize-lecture`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            lectureId: currentLectureData.ID,
            forceRegenerate: true
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `Server Error: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Neue Zusammenfassung generiert und gespeichert');
        
        currentLectureSummary = {
          summary: data.summary,
          headings: data.headings || []
        };
        
        displaySummaryWithHeadings(currentLectureData, currentLectureSummary);
        
        buildTableOfContents();
        
      } catch (error) {
        console.error('Regenerierungs-Fehler:', error);
        alert(`Fehler beim Neu-Generieren: ${error.message}`);
      } finally {
        if (buttonKeyword) {
          buttonKeyword.disabled = false;
          buttonKeyword.classList.remove('processing');
          buttonKeyword.textContent = originalText;
        }
        if (buttonViewer) {
          buttonViewer.disabled = false;
          buttonViewer.classList.remove('processing');
          buttonViewer.textContent = originalText;
        }
      }
    }

    function extractKeywordsFromQuery(query) {
      const stopWords = [
        'wie', 'ist', 'das', 'verhältnis', 'von', 'und', 'der', 'die', 'des', 
        'den', 'dem', 'ein', 'eine', 'einem', 'einen', 'was', 'welche', 'welcher',
        'zwischen', 'bei', 'nach', 'für', 'mit', 'aus', 'über', 'sich', 'zur',
        'steiner', 'rudolf', 'sieht', 'kritisiert', 'spielt', 'rolle'
      ];
      
      const words = query.toLowerCase()
        .replace(/[.,;:!?]/g, ' ')
        .split(/\s+/)
        .filter(word => word.length > 3 && !stopWords.includes(word));
      
      return words;
    }

    function renderThematicResults(query, content, sources) {
      const container = document.getElementById('results');
      
      const sortedSources = [...sources].sort((a, b) => {
        const dateA = a.date || '';
        const dateB = b.date || '';
        return dateA.localeCompare(dateB);
      });
      
      container.innerHTML = `
        <div class="semantic-answer">
          <div class="answer-content" id="answerContent"></div>
        </div>
      `;
      
      const answerDiv = document.getElementById('answerContent');
      answerDiv.innerHTML = marked.parse(content);
      
      document.getElementById('status').textContent = `Antwort aus ${sortedSources.length} Quellen`;
      
      setTimeout(() => {
        const gaLinks = answerDiv.querySelectorAll('.ga-reference');
        
        gaLinks.forEach(link => {
          const lectureId = link.getAttribute('data-id');
          const targetIndex = link.getAttribute('data-index');
          
          if (lectureId && targetIndex) {
            link.addEventListener('click', (e) => {
              e.preventDefault();
              const keywords = extractKeywordsFromQuery(currentThematicQuery);
              showLecture(lectureId, targetIndex, keywords);
            });
          }
        });
      }, 100);
    }

    async function showLectureTop(lectureId) {
      await showLecture(lectureId, null, []);
    }

    async function showLecture(lectureId, targetIndex, keywords = []) {
      try {
        document.getElementById('status').innerHTML = '<span class="loading">Lade Vortrag...</span>';
        
        const summaryPanel = document.getElementById('summary-panel');
        const tocBtn = document.getElementById('tocBtn');
        const resizeHandle = document.getElementById('verticalResizeHandle');
        const tocList = document.getElementById('toc-list');
        
        if (summaryPanel.classList.contains('visible')) {
          summaryPanel.classList.remove('visible');
          resizeHandle.classList.remove('visible');
          if (tocBtn) tocBtn.textContent = 'Inhaltsverzeichnis';
        }
        
        if (tocBtn) tocBtn.style.display = 'none';
        
        if (tocList) tocList.innerHTML = '';
        
        const parts = lectureId.split('/');
        const url = parts.length === 2 
          ? `${API_BASE}/api/full-lecture/${parts[0]}/${parts[1]}`
          : `${API_BASE}/api/full-lecture/${lectureId}`;
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`Vortrag nicht gefunden: ${lectureId}`);
        }
        
        const data = await response.json();
        currentLectureData = data.lecture;
        
        currentLectureSummary = null;
        showingSummaryInMain = false;
        
        let displayKeywords = keywords;
        if (!displayKeywords || displayKeywords.length === 0) {
          const currentWord1 = document.getElementById('word1').value.trim();
          const currentWord2 = document.getElementById('word2').value.trim();
          if (currentWord1 || currentWord2) {
            displayKeywords = [currentWord1, currentWord2].filter(w => w && w.trim());
          }
          else if (currentThematicQuery) {
            displayKeywords = extractKeywordsFromQuery(currentThematicQuery);
          }
        }
        
        console.log('Vortrag geladen - keine automatische Zusammenfassung');
        
        updateButtonStates();
        
        displayLecture(data.lecture, targetIndex, displayKeywords);
        
      } catch (error) {
        console.error('Fehler beim Laden:', error);
        document.getElementById('viewer').innerHTML = `
          <div class="error-message">
            <strong>Fehler beim Laden des Vortrags:</strong><br>${error.message}
          </div>
        `;
      } finally {
        document.getElementById('status').textContent = '';
      }
    }

    function toggleMainView() {
      const viewer = document.getElementById('viewer');
      
      if (!currentLectureData || !currentLectureSummary) return;
      
      if (showingSummaryInMain) {
        showingSummaryInMain = false;
        
        document.getElementById('summary-panel').classList.remove('visible');
        document.getElementById('verticalResizeHandle').classList.remove('visible');
        
        const currentWord1 = document.getElementById('word1').value.trim();
        const currentWord2 = document.getElementById('word2').value.trim();
        let keywords = [currentWord1, currentWord2].filter(w => w && w.trim());
        if (keywords.length === 0 && currentThematicQuery) {
          keywords = extractKeywordsFromQuery(currentThematicQuery);
        }
        
        displayLecture(currentLectureData, null, keywords);
      } else {
        showingSummaryInMain = true;
        displaySummaryWithHeadings(currentLectureData, currentLectureSummary);
        buildTableOfContents();
      }
      
      updateButtonStates();
    }

    function buildTableOfContents() {
      const viewer = document.getElementById('viewer');
      const tocList = document.getElementById('toc-list');
      const mainContainer = document.getElementById('main');
      
      const headings = viewer.querySelectorAll('h1, h2, h3, strong');
      
      tocList.innerHTML = '';
      
      let headingIndex = 0;
      const tocItems = [];
      
      headings.forEach((heading) => {
        if (heading.tagName === 'STRONG' && heading.textContent.length < 10) {
          return;
        }
        
        if (!heading.id) {
          heading.id = `heading-${headingIndex}`;
        }
        headingIndex++;
        
        const tocItem = document.createElement('div');
        tocItem.className = 'toc-item';
        tocItem.setAttribute('data-heading-id', heading.id);
        
        const tocLink = document.createElement('a');
        tocLink.href = '#';
        tocLink.textContent = heading.textContent;
        tocLink.style.color = '#467886';
        tocLink.style.textDecoration = 'none';
        tocLink.style.display = 'block';
        
        tocLink.addEventListener('click', (e) => {
          e.preventDefault();
          heading.scrollIntoView({ behavior: 'auto', block: 'start' });
          
          const originalBg = heading.style.backgroundColor;
          heading.style.backgroundColor = 'rgba(70, 120, 134, 0.2)';
          setTimeout(() => {
            heading.style.backgroundColor = originalBg;
          }, 1000);
        });
        
        tocItem.appendChild(tocLink);
        tocList.appendChild(tocItem);
        tocItems.push({ element: tocItem, heading: heading });
      });
      
      function updateActiveTocItem() {
        const scrollTop = mainContainer.scrollTop;
        const containerTop = mainContainer.getBoundingClientRect().top;
        
        let activeItem = null;
        
        for (let i = tocItems.length - 1; i >= 0; i--) {
          const headingRect = tocItems[i].heading.getBoundingClientRect();
          const relativeTop = headingRect.top - containerTop;
          
          if (relativeTop <= 50) {
            activeItem = tocItems[i].element;
            break;
          }
        }
        
        tocItems.forEach(item => {
          const link = item.element.querySelector('a');
          link.style.fontWeight = 'normal';
          link.style.color = '#467886';
        });
        
        if (activeItem) {
          const link = activeItem.querySelector('a');
          link.style.fontWeight = 'bold';
          link.style.color = '#467886';
        }
      }
      
      mainContainer.removeEventListener('scroll', updateActiveTocItem);
      mainContainer.addEventListener('scroll', updateActiveTocItem);
      
      updateActiveTocItem();
    }

    function toggleTOC() {
      const summaryPanel = document.getElementById('summary-panel');
      const tocBtn = document.getElementById('tocActionBtn');
      const resizeHandle = document.getElementById('verticalResizeHandle');
      
      if (summaryPanel.classList.contains('visible')) {
        summaryPanel.classList.remove('visible');
        resizeHandle.classList.remove('visible');
      } else {
        summaryPanel.classList.add('visible');
        resizeHandle.classList.add('visible');
      }
    }

    function createOnlineURL(lecture) {
      if (!lecture.fileName) {
        return `https://rudolf-steiner-online.de/${lecture.ID || ''}`;
      }
      
      const fileName = lecture.fileName;
      const match = fileName.match(/^(GA\d{3}[a-z]?)\/(\d+)\s*-\s*(.+)$/);
      
      if (!match) {
        return `https://rudolf-steiner-online.de/${lecture.ID || ''}`;
      }
      
      const [, gaNumber, lectureNumber, rest] = match;
      
      const titleForUrl = rest.replace(/ /g, '+');
      const encodedTitle = encodeURIComponent(titleForUrl).replace(/%2B/g, '+');
      
      return `https://rudolf-steiner-online.de/${gaNumber}+(${lectureNumber}.)+${encodedTitle}`;
    }

    function displayLecture(lecture, highlightIndex, keywords = [], shouldHighlight = true) {
      const viewer = document.getElementById('viewer');
      const mainContainer = document.getElementById('main');
      const titleElement = document.getElementById('document-title');
      
      const cleanIndex = highlightIndex ? highlightIndex.replace(/^\^/, '') : null;
      
      viewer.innerHTML = '';
      
      const displayTitle = lecture.fileName || lecture.title || lecture.ID;
      const onlineLink = createOnlineURL(lecture);
      
      titleElement.innerHTML = `<a href="${onlineLink}" target="rudolf-steiner-online">${displayTitle}</a>`;
      
      let html = '<div>';
      
      if (lecture.paragraphs) {
        lecture.paragraphs.forEach((para, idx) => {
          const paraIndex = para.index ? para.index.replace(/^\^/, '') : `para_${idx}`;
          const isTargetPara = cleanIndex && paraIndex === cleanIndex;
          
          let content = para.content || para.text || '';
          
          if (keywords && keywords.length > 0) {
            keywords.forEach(word => {
              if (word && word.trim()) {
                const regex = new RegExp(`(${word.trim()})`, "gi");
                content = content.replace(regex, "<mark>$1</mark>");
              }
            });
          }
          
          const contentLower = content.toLowerCase();
          const hasBothWords = keywords.length === 2 && 
                               keywords[0] && keywords[1] &&
                               contentLower.includes(keywords[0].toLowerCase()) && 
                               contentLower.includes(keywords[1].toLowerCase());
          
          const applyHighlight = shouldHighlight && isTargetPara && (keywords.length === 1 || hasBothWords);
          
          html += `
            <div class="paragraph ${applyHighlight ? 'highlighted-paragraph' : ''}" 
                 id="para-${paraIndex}">
              ${content}
            </div>
          `;
        });
      }
      
      html += `</div>`;
      viewer.innerHTML = html;
      
      if (cleanIndex) {
        const targetElement = document.getElementById(`para-${cleanIndex}`);
        if (targetElement) {
          const mainRect = mainContainer.getBoundingClientRect();
          const targetRect = targetElement.getBoundingClientRect();
          const relativeTop = targetRect.top - mainRect.top + mainContainer.scrollTop;
          mainContainer.scrollTop = relativeTop;
          lastHighlightedIndex = cleanIndex;
        } else {
          mainContainer.scrollTop = 0;
        }
      } else {
        mainContainer.scrollTop = 0;
      }
      
      const summarizeBtn = document.getElementById('summarizeBtn');
      const summarizeBtnKeyword = document.getElementById('summarizeBtnKeyword');
      const summaryActionBtn = document.getElementById('summaryActionBtn');
      
      if (summarizeBtn) {
        summarizeBtn.disabled = false;
      }
      if (summarizeBtnKeyword) {
        summarizeBtnKeyword.disabled = false;
      }
      if (summaryActionBtn) {
        summaryActionBtn.disabled = false;
      }
      
      updateButtonStates();
    }

    function handleKeywordKeypress(event) {
      if (event.key === 'Enter') {
        performKeywordSearch();
      }
    }

    function handleThematicKeydown(event) {
      if (event.ctrlKey && event.key === 'Enter') {
        performThematicSearch();
      }
    }

    function clearResults() {
      document.getElementById('results').innerHTML = "";
      document.getElementById('status').textContent = "";
      document.getElementById('viewer').innerHTML = "";
      document.getElementById('document-title').textContent = "Bitte ein Ergebnis auswählen…";
    }

    function initResizeHandle() {
      const resizeHandle = document.getElementById('resizeHandle');
      const sidebar = document.getElementById('sidebar');
      let isResizing = false;

      resizeHandle.addEventListener('mousedown', function(e) {
        isResizing = true;
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        e.preventDefault();
      });

      function handleMouseMove(e) {
        if (!isResizing) return;
        
        const containerWidth = document.body.clientWidth;
        const newSidebarWidth = (e.clientX / containerWidth) * 100;
        
        if (newSidebarWidth >= 20 && newSidebarWidth <= 90) {
          sidebar.style.width = newSidebarWidth + '%';
        }
      }

      function handleMouseUp() {
        isResizing = false;
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
      }
    }

    function initVerticalResizeHandle() {
      const resizeHandle = document.getElementById('verticalResizeHandle');
      const mainPanel = document.getElementById('main');
      const summaryPanel = document.getElementById('summary-panel');
      let isResizing = false;

      resizeHandle.addEventListener('mousedown', function(e) {
        if (!summaryPanel.classList.contains('visible')) return;
        
        isResizing = true;
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        e.preventDefault();
      });

      function handleMouseMove(e) {
        if (!isResizing) return;
        
        const container = document.getElementById('main-container');
        const containerWidth = container.clientWidth;
        const containerLeft = container.getBoundingClientRect().left;
        const mouseX = e.clientX - containerLeft;
        
        const newMainWidth = (mouseX / containerWidth) * 100;
        
        if (newMainWidth >= 20 && newMainWidth <= 80) {
          mainPanel.style.flex = `${newMainWidth} 0 0`;
          summaryPanel.style.width = `${100 - newMainWidth}%`;
        }
      }

      function handleMouseUp() {
        isResizing = false;
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
      }
    }
  </script>
</body>
</html>